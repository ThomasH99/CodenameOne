<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Resources.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">codenameone-core-unittests</a> &gt; <a href="index.source.html" class="el_package">com.codename1.ui.util</a> &gt; <span class="el_source">Resources.java</span></div><h1>Resources.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2008, 2010, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores
 * CA 94065 USA or visit www.oracle.com if you need additional information or
 * have any questions.
 */
package com.codename1.ui.util;

import com.codename1.io.Log;
import com.codename1.ui.CN;
import com.codename1.ui.Display;
import com.codename1.ui.EncodedImage;
import com.codename1.ui.Font;
import com.codename1.ui.Image;
import com.codename1.ui.animations.AnimationObject;
import com.codename1.ui.animations.Timeline;
import com.codename1.ui.geom.Dimension;
import com.codename1.ui.plaf.Border;
import com.codename1.ui.plaf.CSSBorder;
import com.codename1.ui.plaf.RoundBorder;
import com.codename1.ui.plaf.RoundRectBorder;
import com.codename1.ui.plaf.Style;

import java.io.ByteArrayInputStream;
import java.io.DataInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.UnsupportedEncodingException;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Enumeration;
import java.util.HashMap;
import java.util.Hashtable;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;

/**
 * Loads resources from the binary resource file generated by the Codename One Designer.
 * A resource is loaded entirely into memory since random file access is not supported
 * in all platforms. Any other approach would be inefficient. This means that memory must
 * be made available to accommodate the resource file.
 *
 * @author Shai Almog
 */
public class Resources {

    /**
     * Magic numbers to prevent data corruption
     */
    static final byte MAGIC_THEME_LEGACY = (byte) 0xF7;
    static final byte MAGIC_ANIMATION_LEGACY = (byte) 0xF8;
    static final byte MAGIC_INDEXED_IMAGE_LEGACY = (byte) 0xF4;
    static final byte MAGIC_FONT_LEGACY = (byte) 0xF6;
    static final byte MAGIC_INDEXED_FONT_LEGACY = (byte) 0xFB;
    static final byte MAGIC_IMAGE_LEGACY = (byte) 0xF3;
    static final byte MAGIC_SVG = (byte) 0xF5;
    static final byte MAGIC_TIMELINE = (byte) 0xEF;
    static final byte MAGIC_FONT = (byte) 0xFC;
    static final byte MAGIC_IMAGE = (byte) 0xFD;
    static final byte MAGIC_L10N = (byte) 0xF9;
    static final byte MAGIC_DATA = (byte) 0xFA;
    static final byte MAGIC_UI = (byte) 0xEE;
    static final byte MAGIC_HEADER = (byte) 0xFF;
    static final byte MAGIC_PASSWORD = (byte) 0xFE;
    /**
     * Temporary member for compatibility with older versions, in future versions
     * this will supersede the MAGIC_THEME property
     */
    static final byte MAGIC_THEME = (byte) 0xF2;
    static final int BORDER_TYPE_EMPTY = 0;
    static final int BORDER_TYPE_LINE = 1;
    static final int BORDER_TYPE_ROUNDED = 2;
    static final int BORDER_TYPE_ETCHED_LOWERED = 4;
    static final int BORDER_TYPE_ETCHED_RAISED = 5;
    static final int BORDER_TYPE_BEVEL_RAISED = 6;
    static final int BORDER_TYPE_BEVEL_LOWERED = 7;
    static final int BORDER_TYPE_IMAGE = 8;
    static final int BORDER_TYPE_IMAGE_HORIZONTAL = 10;
    static final int BORDER_TYPE_IMAGE_VERTICAL = 11;
    static final int BORDER_TYPE_DASHED = 12;
    static final int BORDER_TYPE_DOTTED = 13;
    static final int BORDER_TYPE_DOUBLE = 14;
    static final int BORDER_TYPE_GROOVE = 15;
    static final int BORDER_TYPE_RIDGE = 16;
    static final int BORDER_TYPE_INSET = 17;
    static final int BORDER_TYPE_OUTSET = 18;
    static final int BORDER_TYPE_IMAGE_SCALED = 19;
    static final int BORDER_TYPE_IMAGE_ROUND = 20;
    static final int BORDER_TYPE_UNDERLINE = 21;
    private static final String systemResourceLocation = &quot;/CN1Resource.res&quot;;
<span class="fc" id="L111">    private static boolean enableMediaQueries = true;</span>
    /**
     * This variable is used by new GUI builder apps to keep track of the applications resources
     */
    private static Resources globalResources;
    /**
     * This variable is used to cache the system resources file CN1Resource.res
     */
    private static Resources systemResource;
    private static byte[] key;
    // for use by the resource editor
<span class="fc" id="L122">    private static Class classLoader = Resources.class;</span>
    /**
     * These variables are useful for caching the last loaded resource which might
     * happen frequently in the UI builder when moving between applications screens
     */
    private static Object cachedResource;
    private static String lastLoadedName;
    private static int lastLoadedDPI;
    private static boolean runtimeMultiImages;
<span class="fc" id="L131">    private static boolean failOnMissingTruetype = true;</span>
    short majorVersion;
    short minorVersion;
    int keyOffset;
    private String[] metaData;
<span class="fc" id="L136">    private int dpi = -1;</span>
    /**
     * Hashtable containing the mapping between element types and their names in the
     * resource hashtable
     */
<span class="fc" id="L141">    private final HashMap&lt;String, Byte&gt; resourceTypes = new HashMap&lt;String, Byte&gt;();</span>
    /**
     * A cache within the resource allowing us to preserve some resources in memory
     * so they can be utilized by a theme when it is loaded
     */
<span class="fc" id="L146">    private final HashMap&lt;String, Object&gt; resources = new HashMap&lt;String, Object&gt;();</span>
    private DataInputStream input;

    // for internal use by the resource editor, creates an empty resource
<span class="fc" id="L150">    Resources() {</span>
<span class="fc" id="L151">    }</span>

<span class="fc" id="L153">    Resources(InputStream input, int dpi) throws IOException {</span>
<span class="fc" id="L154">        this.dpi = dpi;</span>
<span class="fc" id="L155">        openFile(input);</span>
<span class="fc" id="L156">    }</span>

    /**
     * @return the failOnMissingTruetype
     */
    public static boolean isFailOnMissingTruetype() {
<span class="fc" id="L162">        return failOnMissingTruetype;</span>
    }

    /**
     * @param aFailOnMissingTruetype the failOnMissingTruetype to set
     */
    public static void setFailOnMissingTruetype(boolean aFailOnMissingTruetype) {
<span class="fc" id="L169">        failOnMissingTruetype = aFailOnMissingTruetype;</span>
<span class="fc" id="L170">    }</span>

    public static boolean isEnableMediaQueries() {
<span class="fc" id="L173">        return enableMediaQueries;</span>
    }

    public static void setEnableMediaQueries(boolean enable) {
<span class="fc" id="L177">        enableMediaQueries = enable;</span>
<span class="fc" id="L178">    }</span>

    /**
     * This flag should be off and it is off by default, some special case implementations for development
     * e.g. the AWT implementation activate this flag in order to use the EncodedImage multi-image support
     * which is entirely for development only!
     *
     * @deprecated do not use this method!
     */
    public static void setRuntimeMultiImageEnabled(boolean b) {
<span class="fc" id="L188">        runtimeMultiImages = b;</span>
<span class="fc" id="L189">    }</span>

    static void setClassLoader(Class cls) {
<span class="fc" id="L192">        classLoader = cls;</span>
<span class="fc" id="L193">    }</span>

    /**
     * Sets the password to use for password protected resource files
     *
     * @param password the password or null to clear the password
     */
    public static void setPassword(String password) {
<span class="fc bfc" id="L201" title="All 2 branches covered.">        if (password == null) {</span>
<span class="fc" id="L202">            key = null;</span>
<span class="fc" id="L203">            return;</span>
        }
        try {
<span class="fc" id="L206">            key = password.getBytes(&quot;UTF-8&quot;);</span>
<span class="nc" id="L207">        } catch (UnsupportedEncodingException ex) {</span>
            // won't happen
<span class="nc" id="L209">            Log.e(ex);</span>
<span class="fc" id="L210">        }</span>
<span class="fc" id="L211">    }</span>

    private static String[] toStringArray(ArrayList&lt;String&gt; v) {
<span class="fc" id="L214">        String[] s = new String[v.size()];</span>
<span class="fc" id="L215">        int slen = v.size();</span>
<span class="fc bfc" id="L216" title="All 2 branches covered.">        for (int iter = 0; iter &lt; slen; iter++) {</span>
<span class="fc" id="L217">            s[iter] = v.get(iter);</span>
        }
<span class="fc" id="L219">        return s;</span>
    }

    /**
     * Opens a multi-layer resource file that supports overriding features on a specific
     * platform. Notice that the &quot;.res&quot; extension MUST not be given to this method!
     *
     * @param resource a local reference to a resource using the syntax of Class.getResourceAsStream(String)
     *                 however &lt;b&gt;the extension MUST not be included in the name!&lt;/b&gt; E.g. to reference /x.res use /x
     * @return a resource object
     * @throws java.io.IOException if opening/reading the resource fails
     */
    public static Resources openLayered(String resource) throws IOException {
<span class="nc" id="L232">        return openLayered(resource, -1);</span>
    }

    /**
     * Creates a resource object from the local JAR resource identifier
     *
     * @param resource a local reference to a resource using the syntax of Class.getResourceAsStream(String)
     * @return a resource object
     * @throws java.io.IOException if opening/reading the resource fails
     */
    public static Resources open(String resource) throws IOException {
<span class="nc" id="L243">        return open(resource, -1);</span>
    }

    /**
     * Creates a resource object from the given input stream
     *
     * @param resource stream from which to read the resource
     * @return a resource object
     * @throws java.io.IOException if opening/reading the resource fails
     */
    public static Resources open(InputStream resource) throws IOException {
<span class="nc" id="L254">        return open(resource, -1);</span>
    }

    /**
     * Opens a multi-layer resource file that supports overriding features on a specific
     * platform. Notice that the &quot;.res&quot; extension MUST not be given to this method!
     *
     * @param resource a local reference to a resource using the syntax of Class.getResourceAsStream(String)
     *                 however &lt;b&gt;the extension MUST not be included in the name!&lt;/b&gt; E.g. to reference /x.res use /x
     * @param dpi      the dpi used for the loaded images
     * @return a resource object
     * @throws java.io.IOException if opening/reading the resource fails
     */
    public static Resources openLayered(String resource, int dpi) throws IOException {
<span class="nc" id="L268">        Resources r = open(resource + &quot;.res&quot;, dpi);</span>

<span class="nc" id="L270">        String[] over = Display.getInstance().getPlatformOverrides();</span>
<span class="nc" id="L271">        int olen = over.length;</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">        for (int iter = 0; iter &lt; olen; iter++) {</span>
<span class="nc" id="L273">            InputStream i = Display.getInstance().getResourceAsStream(classLoader, resource + &quot;_&quot; + over[iter] + &quot;.ovr&quot;);</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">            if (i != null) {</span>
<span class="nc" id="L275">                r.override(i);</span>
<span class="nc" id="L276">                i.close();</span>
            }
        }

<span class="nc" id="L280">        return r;</span>
    }

    /**
     * Creates a resource object from the local JAR resource identifier
     *
     * @param resource a local reference to a resource using the syntax of Class.getResourceAsStream(String)
     * @param dpi      the dpi used for the loaded images
     * @return a resource object
     * @throws java.io.IOException if opening/reading the resource fails
     */
    public static Resources open(String resource, int dpi) throws IOException {
        try {
<span class="nc bnc" id="L293" title="All 4 branches missed.">            if (resource.equals(Resources.systemResourceLocation) &amp;&amp; systemResource != null) {</span>
<span class="nc" id="L294">                return systemResource;</span>
            }
<span class="nc bnc" id="L296" title="All 6 branches missed.">            if (lastLoadedName != null &amp;&amp; lastLoadedName.equals(resource) &amp;&amp; lastLoadedDPI == dpi) {</span>
<span class="nc" id="L297">                Resources r = (Resources) Display.getInstance().extractHardRef(cachedResource);</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">                if (r != null) {</span>
<span class="nc" id="L299">                    return r;</span>
                }
            }
<span class="nc" id="L302">            InputStream is = Display.getInstance().getResourceAsStream(classLoader, resource);</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">            if (is == null) {</span>
<span class="nc" id="L304">                throw new IOException(resource + &quot; not found&quot;);</span>
            }
<span class="nc" id="L306">            Resources r = new Resources(is, dpi);</span>
<span class="nc" id="L307">            is.close();</span>

<span class="nc bnc" id="L309" title="All 2 branches missed.">            if (resource.equals(Resources.systemResourceLocation)) {</span>
<span class="nc" id="L310">                systemResource = r;</span>
<span class="nc" id="L311">                return r;</span>
            }

<span class="nc" id="L314">            lastLoadedDPI = dpi;</span>
<span class="nc" id="L315">            lastLoadedName = resource;</span>
<span class="nc" id="L316">            cachedResource = Display.getInstance().createSoftWeakRef(r);</span>
<span class="nc" id="L317">            return r;</span>
<span class="nc" id="L318">        } catch (RuntimeException err) {</span>
            // intercept exceptions since user code might not deal well with runtime exceptions
<span class="nc" id="L320">            Log.e(err);</span>
<span class="nc" id="L321">            throw new IOException(err.getMessage());</span>
        }
    }

    /**
     * Creates a resource object from the given input stream
     *
     * @param resource stream from which to read the resource
     * @param dpi      the dpi used for the loaded images
     * @return a resource object
     * @throws java.io.IOException if opening/reading the resource fails
     */
    public static Resources open(InputStream resource, int dpi) throws IOException {
<span class="nc" id="L334">        return new Resources(resource, dpi);</span>
    }

    /**
     * Gets the system resource which can be located /CN1Images.res.
     *
     * @return a Resources object which contains the system resources
     */
    public static Resources getSystemResource() {
        try {
<span class="nc" id="L344">            return open(systemResourceLocation);</span>
<span class="nc" id="L345">        } catch (IOException ex) {</span>
<span class="nc" id="L346">            Log.e(ex);</span>
        }
<span class="nc" id="L348">        return null;</span>
    }

    /**
     * Global resources are used by new GUI builder apps to keep track of the applications resources
     *
     * @return the resource object used by default in the GUI builder forms
     */
    public static Resources getGlobalResources() {
<span class="nc" id="L357">        return globalResources;</span>
    }

    /**
     * Global resources are used by new GUI builder apps to keep track of the applications resources
     *
     * @param res the resource object used by default in the GUI builder forms
     */
    public static void setGlobalResources(Resources res) {
<span class="nc" id="L366">        globalResources = res;</span>
<span class="nc" id="L367">    }</span>

    void clear() {
<span class="fc" id="L370">        majorVersion = 0;</span>
<span class="fc" id="L371">        minorVersion = 0;</span>
<span class="fc" id="L372">        resourceTypes.clear();</span>
<span class="fc" id="L373">        resources.clear();</span>
<span class="fc" id="L374">        input = null;</span>
<span class="fc" id="L375">    }</span>

    Timeline readTimeline(DataInputStream input) throws IOException {
<span class="nc" id="L378">        int duration = input.readInt();</span>
<span class="nc" id="L379">        int width = input.readInt();</span>
<span class="nc" id="L380">        int height = input.readInt();</span>
<span class="nc" id="L381">        AnimationObject[] animations = new AnimationObject[input.readShort()];</span>
<span class="nc" id="L382">        int alen = animations.length;</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">        for (int iter = 0; iter &lt; alen; iter++) {</span>
<span class="nc" id="L384">            String name = input.readUTF();</span>
<span class="nc" id="L385">            int startTime = input.readInt();</span>
<span class="nc" id="L386">            int animDuration = input.readInt();</span>
<span class="nc" id="L387">            int x = input.readInt();</span>
<span class="nc" id="L388">            int y = input.readInt();</span>
<span class="nc" id="L389">            Image i = getImage(name);</span>
<span class="nc bnc" id="L390" title="All 2 branches missed.">            if (i == null) {</span>
<span class="nc" id="L391">                animations[iter] = AnimationObject.createAnimationImage(name, this, x, y);</span>
            } else {
<span class="nc" id="L393">                animations[iter] = AnimationObject.createAnimationImage(i, x, y);</span>
            }
<span class="nc" id="L395">            animations[iter].setStartTime(startTime);</span>
<span class="nc" id="L396">            animations[iter].setEndTime(startTime + animDuration);</span>
<span class="nc" id="L397">            int frameDelay = input.readInt();</span>
<span class="nc bnc" id="L398" title="All 2 branches missed.">            if (frameDelay &gt; -1) {</span>
<span class="nc" id="L399">                int frameWidth = input.readInt();</span>
<span class="nc" id="L400">                int frameHeight = input.readInt();</span>
<span class="nc" id="L401">                animations[iter].defineFrames(frameWidth, frameHeight, frameDelay);</span>
            }
<span class="nc bnc" id="L403" title="All 2 branches missed.">            if (input.readBoolean()) {</span>
<span class="nc" id="L404">                animations[iter].defineMotionX(input.readInt(), startTime, animDuration, x, input.readInt());</span>
            }
<span class="nc bnc" id="L406" title="All 2 branches missed.">            if (input.readBoolean()) {</span>
<span class="nc" id="L407">                animations[iter].defineMotionY(input.readInt(), startTime, animDuration, y, input.readInt());</span>
            }
<span class="nc bnc" id="L409" title="All 2 branches missed.">            if (input.readBoolean()) {</span>
<span class="nc" id="L410">                animations[iter].defineWidth(input.readInt(), startTime, animDuration, input.readInt(), input.readInt());</span>
            }
<span class="nc bnc" id="L412" title="All 2 branches missed.">            if (input.readBoolean()) {</span>
<span class="nc" id="L413">                animations[iter].defineHeight(input.readInt(), startTime, animDuration, input.readInt(), input.readInt());</span>
            }
<span class="nc bnc" id="L415" title="All 2 branches missed.">            if (input.readBoolean()) {</span>
<span class="nc" id="L416">                animations[iter].defineOpacity(input.readInt(), startTime, animDuration, input.readInt(), input.readInt());</span>
            }
<span class="nc bnc" id="L418" title="All 2 branches missed.">            if (input.readBoolean()) {</span>
<span class="nc" id="L419">                animations[iter].defineOrientation(input.readInt(), startTime, animDuration, input.readInt(), input.readInt());</span>
            }
        }
<span class="nc" id="L422">        Timeline tl = Timeline.createTimeline(duration, animations, new Dimension(width, height));</span>
<span class="nc" id="L423">        return tl;</span>
    }

    /**
     * This method is used by the Codename One Designer
     */
    void startingEntry(String id, byte magic) {
<span class="fc" id="L430">    }</span>

    /**
     * This method allows overriding the data of a resource file with another resource file thus replacing
     * or enhancing existing content with platform specific content. E.g. default icons for the application
     * can be overriden on a specific platform
     *
     * @param input a new resource file
     * @throws IOException exception thrown from the stream
     */
    public void override(InputStream input) throws IOException {
<span class="nc" id="L441">        openFileImpl(input);</span>
<span class="nc" id="L442">    }</span>

    void openFile(InputStream input) throws IOException {
<span class="fc" id="L445">        clear();</span>
<span class="fc" id="L446">        openFileImpl(input);</span>
<span class="fc" id="L447">    }</span>

    private void openFileImpl(InputStream input) throws IOException {
<span class="fc" id="L450">        this.input = new DataInputStream(input);</span>
<span class="fc" id="L451">        int resourceCount = this.input.readShort();</span>
<span class="fc bfc" id="L452" title="All 2 branches covered.">        if (resourceCount &lt; 0) {</span>
<span class="fc" id="L453">            throw new IOException(&quot;Invalid resource file!&quot;);</span>
        }
<span class="fc" id="L455">        boolean password = false;</span>
<span class="fc" id="L456">        keyOffset = 0;</span>
<span class="fc bfc" id="L457" title="All 2 branches covered.">        for (int iter = 0; iter &lt; resourceCount; iter++) {</span>
<span class="fc" id="L458">            byte magic = this.input.readByte();</span>
<span class="fc" id="L459">            String id = this.input.readUTF();</span>
<span class="fc bfc" id="L460" title="All 2 branches covered.">            if (password) {</span>
<span class="fc" id="L461">                magic = (byte) decode(magic &amp; 0xff);</span>
<span class="fc" id="L462">                char[] chars = id.toCharArray();</span>
<span class="fc" id="L463">                int clen = chars.length;</span>
<span class="fc bfc" id="L464" title="All 2 branches covered.">                for (int i = 0; i &lt; clen; i++) {</span>
<span class="fc" id="L465">                    chars[i] = (char) decode(chars[i] &amp; 0xffff);</span>
                }
<span class="fc" id="L467">                id = new String(chars);</span>
            }

<span class="fc" id="L470">            startingEntry(id, magic);</span>
<span class="pc bpc" id="L471" title="8 of 13 branches missed.">            switch (magic) {</span>
                case MAGIC_PASSWORD:
<span class="fc" id="L473">                    checkKey(id);</span>
<span class="fc" id="L474">                    password = true;</span>
<span class="fc" id="L475">                    continue;</span>
                case MAGIC_HEADER:
<span class="fc" id="L477">                    readHeader();</span>
<span class="fc" id="L478">                    continue;</span>
                case MAGIC_THEME:
                case MAGIC_THEME_LEGACY:
<span class="nc bnc" id="L481" title="All 2 branches missed.">                    setResource(id, MAGIC_THEME, loadTheme(id, magic == MAGIC_THEME));</span>
<span class="nc" id="L482">                    continue;</span>
                case MAGIC_IMAGE:
<span class="nc" id="L484">                    Image img = createImage();</span>
<span class="nc" id="L485">                    img.setImageName(id);</span>
<span class="nc" id="L486">                    setResource(id, magic, img);</span>
<span class="nc" id="L487">                    continue;</span>
                case MAGIC_FONT:
<span class="nc" id="L489">                    setResource(id, magic, loadFont(this.input, id, false));</span>
<span class="nc" id="L490">                    continue;</span>
                case MAGIC_DATA:
<span class="fc" id="L492">                    setResource(id, magic, createData());</span>
<span class="fc" id="L493">                    continue;</span>
                case MAGIC_UI:
<span class="fc" id="L495">                    setResource(id, magic, createData());</span>
<span class="fc" id="L496">                    continue;</span>
                case MAGIC_L10N:
<span class="fc" id="L498">                    setResource(id, magic, loadL10N());</span>
<span class="fc" id="L499">                    continue;</span>

                    // legacy file support to be removed
                case MAGIC_IMAGE_LEGACY:
<span class="nc" id="L503">                    setResource(id, MAGIC_IMAGE, createImage());</span>
<span class="nc" id="L504">                    continue;</span>
                case MAGIC_INDEXED_IMAGE_LEGACY:
<span class="nc" id="L506">                    setResource(id, MAGIC_IMAGE, createPackedImage8());</span>
<span class="nc" id="L507">                    continue;</span>
                case MAGIC_FONT_LEGACY:
<span class="nc" id="L509">                    setResource(id, MAGIC_FONT, loadFont(this.input, id, false));</span>
<span class="nc" id="L510">                    continue;</span>
                case MAGIC_INDEXED_FONT_LEGACY:
<span class="nc" id="L512">                    setResource(id, MAGIC_FONT, loadFont(this.input, id, true));</span>
<span class="nc" id="L513">                    continue;</span>
                default:
<span class="nc" id="L515">                    throw new IOException(&quot;Corrupt theme file unrecognized magic number: &quot; + Integer.toHexString(magic &amp; 0xff));</span>
            }
        }
<span class="fc" id="L518">    }</span>

    void checkKey(String id) {
<span class="fc bfc" id="L521" title="All 2 branches covered.">        if (key == null) {</span>
<span class="fc" id="L522">            throw new IllegalStateException(&quot;This is a password protected resource&quot;);</span>
        }
<span class="fc" id="L524">        char l = (char) decode(id.charAt(0));</span>
<span class="fc" id="L525">        char w = (char) decode(id.charAt(1));</span>
<span class="pc bpc" id="L526" title="2 of 4 branches missed.">        if (l != 'l' || w != 'w') {</span>
<span class="nc" id="L527">            throw new IllegalStateException(&quot;Incorrect password&quot;);</span>
        }
<span class="fc" id="L529">    }</span>

    private int decode(int val) {
<span class="fc" id="L532">        val = key[keyOffset] ^ val;</span>
<span class="fc" id="L533">        keyOffset++;</span>
<span class="fc bfc" id="L534" title="All 2 branches covered.">        if (keyOffset == key.length) {</span>
<span class="fc" id="L535">            keyOffset = 0;</span>
        }
<span class="fc" id="L537">        return val;</span>
    }

    /**
     * Reads the header of the resource file
     */
    private void readHeader() throws IOException {
        // The header begins with a short denoting the size of the header section.
        // We don't currently use this value, but it must be consumed so that the
        // subsequent reads stay aligned with the original format.
<span class="fc" id="L547">        input.readShort();</span>
<span class="fc" id="L548">        majorVersion = input.readShort();</span>
<span class="fc" id="L549">        minorVersion = input.readShort();</span>

<span class="fc" id="L551">        metaData = new String[input.readShort()];</span>
<span class="fc" id="L552">        int mlen = metaData.length;</span>
<span class="fc bfc" id="L553" title="All 2 branches covered.">        for (int iter = 0; iter &lt; mlen; iter++) {</span>
<span class="fc" id="L554">            metaData[iter] = input.readUTF();</span>
        }
<span class="fc" id="L556">    }</span>

    /**
     * Returns the version number for this resource file.
     * This value relates to the value from the header defined by the resource file
     * specification. 0 is returned for legacy versions of the resource file format.
     *
     * @return major version number for the resource file
     */
    public int getMajorVersion() {
<span class="fc" id="L566">        return majorVersion;</span>
    }

    /**
     * Returns the minor version number for this resource file
     * This value relates to the value from the header defined by the resource file
     * specification.
     *
     * @return minor version number for the resource file
     */
    public int getMinorVersion() {
<span class="fc" id="L577">        return minorVersion;</span>
    }

    /**
     * Returns optional meta-data associated with the resource file
     *
     * @return optional meta-data associated with the file
     */
    public String[] getMetaData() {
<span class="fc" id="L586">        return metaData;</span>
    }

    /**
     * Returns the names of the resources within this bundle
     *
     * @return array of names of all the resources in this bundle
     */
    public String[] getResourceNames() {
<span class="fc" id="L595">        String[] arr = new String[resourceTypes.size()];</span>
<span class="fc" id="L596">        Iterator&lt;String&gt; e = resourceTypes.keySet().iterator();</span>
<span class="fc" id="L597">        int alen = arr.length;</span>
<span class="fc bfc" id="L598" title="All 2 branches covered.">        for (int iter = 0; iter &lt; alen; iter++) {</span>
<span class="fc" id="L599">            arr[iter] = e.next();</span>
        }
<span class="fc" id="L601">        return arr;</span>
    }

    /**
     * Returns the names of the data resources within this bundle
     *
     * @return array of names of the data resources in this bundle
     */
    public String[] getDataResourceNames() {
<span class="fc" id="L610">        return getResourceTypeNames(MAGIC_DATA);</span>
    }

    /**
     * Returns the names of the ui resources within this bundle
     *
     * @return array of names of the ui resources in this bundle
     */
    public String[] getUIResourceNames() {
<span class="fc" id="L619">        return getResourceTypeNames(MAGIC_UI);</span>
    }

    /**
     * For internal use only
     */
    void setResource(String id, byte type, Object value) {
<span class="pc bpc" id="L626" title="1 of 2 branches missed.">        if (value == null) {</span>
<span class="nc" id="L627">            resources.remove(id);</span>
<span class="nc" id="L628">            resourceTypes.remove(id);</span>
        } else {
<span class="fc" id="L630">            resources.put(id, value);</span>
<span class="fc" id="L631">            resourceTypes.put(id, Byte.valueOf(type));</span>
        }
<span class="fc" id="L633">    }</span>

    /**
     * Returns the names of the localization bundles within this bundle
     *
     * @return array of names of the localization resources in this bundle
     */
    public String[] getL10NResourceNames() {
<span class="fc" id="L641">        return getResourceTypeNames(MAGIC_L10N);</span>
    }

    /**
     * Returns the names of the fonts within this bundle
     *
     * @return array of names of the font resources in this bundle
     */
    public String[] getFontResourceNames() {
<span class="fc" id="L650">        ArrayList&lt;String&gt; vec = new ArrayList&lt;String&gt;();</span>
<span class="fc" id="L651">        Iterator&lt;String&gt; e = resourceTypes.keySet().iterator();</span>
<span class="fc bfc" id="L652" title="All 2 branches covered.">        while (e.hasNext()) {</span>
<span class="fc" id="L653">            String c = e.next();</span>
<span class="fc bfc" id="L654" title="All 2 branches covered.">            if (isFont(c)) {</span>
<span class="fc" id="L655">                vec.add(c);</span>
            }
<span class="fc" id="L657">        }</span>
<span class="fc" id="L658">        return toStringArray(vec);</span>
    }

    /**
     * Returns the names of the images within this bundle
     *
     * @return array of names of the image resources in this bundle
     */
    public String[] getThemeResourceNames() {
<span class="fc" id="L667">        ArrayList&lt;String&gt; vec = new ArrayList&lt;String&gt;();</span>
<span class="fc" id="L668">        Iterator&lt;String&gt; e = resourceTypes.keySet().iterator();</span>
<span class="fc bfc" id="L669" title="All 2 branches covered.">        while (e.hasNext()) {</span>
<span class="fc" id="L670">            String c = e.next();</span>
<span class="fc bfc" id="L671" title="All 2 branches covered.">            if (isTheme(c)) {</span>
<span class="fc" id="L672">                vec.add(c);</span>
            }
<span class="fc" id="L674">        }</span>
<span class="fc" id="L675">        return toStringArray(vec);</span>
    }

    /**
     * Returns the names of the images within this bundle
     *
     * @return array of names of the image resources in this bundle
     */
    public String[] getImageResourceNames() {
<span class="fc" id="L684">        ArrayList&lt;String&gt; vec = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L685" title="All 2 branches covered.">        for (Map.Entry&lt;String, Byte&gt; entry : resourceTypes.entrySet()) {</span>
<span class="fc" id="L686">            String c = entry.getKey();</span>
<span class="fc bfc" id="L687" title="All 2 branches covered.">            if (isImage(c)) {</span>
<span class="fc" id="L688">                vec.add(c);</span>
            }
<span class="fc" id="L690">        }</span>
<span class="fc" id="L691">        return toStringArray(vec);</span>
    }

    /**
     * For internal use only
     */
    byte getResourceType(String name) {
<span class="fc" id="L698">        Byte b = resourceTypes.get(name);</span>
<span class="pc bpc" id="L699" title="1 of 2 branches missed.">        if (b == null) {</span>
<span class="nc" id="L700">            return (byte) 0;</span>
        }
<span class="fc" id="L702">        return b.byteValue();</span>
    }

    private String[] getResourceTypeNames(byte b) {
<span class="fc" id="L706">        ArrayList&lt;String&gt; vec = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L707" title="All 2 branches covered.">        for (Map.Entry&lt;String, Byte&gt; entry : resourceTypes.entrySet()) {</span>
<span class="fc bfc" id="L708" title="All 2 branches covered.">            if (entry.getValue().byteValue() == b) {</span>
<span class="fc" id="L709">                vec.add(entry.getKey());</span>
            }
<span class="fc" id="L711">        }</span>
<span class="fc" id="L712">        return toStringArray(vec);</span>
    }

    /**
     * Returns true if this is a generic data resource
     *
     * @param name the name of the resource
     * @return true if the resource is a data resource
     * @throws NullPointerException if the resource doesn't exist
     */
    public boolean isL10N(String name) {
<span class="fc" id="L723">        byte b = resourceTypes.get(name).byteValue();</span>
<span class="pc bpc" id="L724" title="1 of 2 branches missed.">        return b == MAGIC_L10N;</span>
    }

    /**
     * Returns true if this is a theme resource
     *
     * @param name the name of the resource
     * @return true if the resource is a theme
     * @throws NullPointerException if the resource doesn't exist
     */
    public boolean isTheme(String name) {
<span class="fc" id="L735">        byte b = resourceTypes.get(name).byteValue();</span>
<span class="pc bpc" id="L736" title="1 of 4 branches missed.">        return b == MAGIC_THEME_LEGACY || b == MAGIC_THEME;</span>
    }

    /**
     * Returns true if this is a font resource
     *
     * @param name the name of the resource
     * @return true if the resource is a font
     * @throws NullPointerException if the resource doesn't exist
     */
    public boolean isFont(String name) {
<span class="fc" id="L747">        byte b = resourceTypes.get(name).byteValue();</span>
<span class="pc bpc" id="L748" title="1 of 6 branches missed.">        return b == MAGIC_FONT || b == MAGIC_FONT_LEGACY || b == MAGIC_INDEXED_FONT_LEGACY;</span>
    }

    /**
     * Returns true if this is an animation resource
     *
     * @param name the name of the resource
     * @return true if the resource is an animation
     * @throws NullPointerException if the resource doesn't exist
     * @deprecated animations are no longer distinguished from images in the resource file, use Image.isAnimation instead
     */
    public boolean isAnimation(String name) {
<span class="fc" id="L760">        byte b = resourceTypes.get(name).byteValue();</span>
<span class="pc bpc" id="L761" title="1 of 2 branches missed.">        return b == MAGIC_ANIMATION_LEGACY;</span>
    }

    /**
     * Returns true if this is a data resource
     *
     * @param name the name of the resource
     * @return true if the resource is a data resource
     * @throws NullPointerException if the resource doesn't exist
     */
    public boolean isData(String name) {
<span class="fc" id="L772">        byte b = resourceTypes.get(name).byteValue();</span>
<span class="pc bpc" id="L773" title="1 of 2 branches missed.">        return b == MAGIC_DATA;</span>
    }

    /**
     * Returns true if this is a UI resource
     *
     * @param name the name of the resource
     * @return true if the resource is a UI resource
     * @throws NullPointerException if the resource doesn't exist
     */
    public boolean isUI(String name) {
<span class="fc" id="L784">        byte b = resourceTypes.get(name).byteValue();</span>
<span class="pc bpc" id="L785" title="1 of 2 branches missed.">        return b == MAGIC_UI;</span>
    }

    /**
     * Returns true if this is an image resource
     *
     * @param name the name of the resource
     * @return true if the resource is an image
     * @throws NullPointerException if the resource doesn't exist
     */
    public boolean isImage(String name) {
<span class="fc" id="L796">        Byte bt = resourceTypes.get(name);</span>
<span class="fc bfc" id="L797" title="All 2 branches covered.">        if (bt == null) {</span>
<span class="fc" id="L798">            return false;</span>
        }
<span class="fc" id="L800">        byte b = bt.byteValue();</span>
<span class="pc bpc" id="L801" title="3 of 10 branches missed.">        return b == MAGIC_IMAGE_LEGACY || b == MAGIC_ANIMATION_LEGACY ||</span>
                b == MAGIC_INDEXED_IMAGE_LEGACY || b == MAGIC_IMAGE ||
                b == MAGIC_TIMELINE;
    }

    /**
     * Returns the image resource from the file
     *
     * @param id name of the image resource
     * @return cached image instance
     */
    public Image getImage(String id) {
<span class="nc" id="L813">        return (Image) resources.get(id);</span>
    }

    /**
     * Returns the data resource from the file
     *
     * @param id name of the data resource
     * @return newly created input stream that allows reading the data of the resource
     */
    public InputStream getData(String id) {
<span class="fc" id="L823">        byte[] data = (byte[]) resources.get(id);</span>
<span class="pc bpc" id="L824" title="1 of 2 branches missed.">        if (data == null) {</span>
<span class="nc" id="L825">            return null;</span>
        }
<span class="fc" id="L827">        return new ByteArrayInputStream(data);</span>
    }

    /**
     * Returns the ui resource from the file
     *
     * @param id name of the ui resource
     * @return newly created input stream that allows reading the ui of the resource
     */
    InputStream getUi(String id) {
<span class="fc" id="L837">        byte[] d = (byte[]) resources.get(id);</span>
<span class="pc bpc" id="L838" title="1 of 2 branches missed.">        if (d == null) {</span>
<span class="nc" id="L839">            return null;</span>
        }
<span class="fc" id="L841">        return new ByteArrayInputStream(d);</span>
    }

    /**
     * Returns a hashmap containing localized String key/value pairs for the given locale name
     *
     * @param id     the name of the locale resource
     * @param locale name of the locale resource
     * @return Hashtable containing key value pairs for localized data
     */
    public Hashtable&lt;String, String&gt; getL10N(String id, String locale) {
<span class="fc" id="L852">        return (Hashtable&lt;String, String&gt;) ((Hashtable) resources.get(id)).get(locale);</span>
    }

    /**
     * Returns an enumration of the locales supported by this resource id
     *
     * @param id the name of the locale resource
     * @return enumeration of strings containing bundle names
     */
    public Enumeration listL10NLocales(String id) {
<span class="fc" id="L862">        return ((Hashtable) resources.get(id)).keys();</span>
    }

    /**
     * Returns a collection of the l10 locale names
     *
     * @param id the name of the locale resource
     * @return collection of strings containing bundle names
     */
    public Collection&lt;String&gt; l10NLocaleSet(String id) {
<span class="fc" id="L872">        return ((Hashtable&lt;String, String&gt;) resources.get(id)).keySet();</span>
    }

    /**
     * Returns the font resource from the file
     *
     * @param id name of the font resource
     * @return cached font instance
     */
    public Font getFont(String id) {
<span class="nc" id="L882">        return (Font) resources.get(id);</span>
    }

    /**
     * Returns the theme resource from the file
     *
     * @param id name of the theme resource
     * @return cached theme instance
     */
    public Hashtable getTheme(String id) {
<span class="nc" id="L892">        Hashtable h = (Hashtable) resources.get(id);</span>

        // theme can be null in valid use cases such as the resource editor
<span class="nc bnc" id="L895" title="All 4 branches missed.">        if (h != null &amp;&amp; h.containsKey(&quot;uninitialized&quot;)) {</span>
<span class="nc" id="L896">            Enumeration e = h.keys();</span>
<span class="nc bnc" id="L897" title="All 2 branches missed.">            while (e.hasMoreElements()) {</span>
<span class="nc" id="L898">                String key = (String) e.nextElement();</span>
<span class="nc bnc" id="L899" title="All 6 branches missed.">                if (key.endsWith(&quot;font&quot;) || (key.endsWith(&quot;Image&quot;) &amp;&amp; !key.endsWith(&quot;scaledImage&quot;))) {</span>
<span class="nc" id="L900">                    Object value = h.get(key);</span>
<span class="nc bnc" id="L901" title="All 2 branches missed.">                    if (value == null) {</span>
<span class="nc" id="L902">                        throw new IllegalArgumentException(&quot;Couldn't find resource: &quot; + key);</span>
                    }

                    // the resource was not already loaded when we loaded the theme
                    // it must be loaded now so we can resolve the temporary name
<span class="nc bnc" id="L907" title="All 2 branches missed.">                    if (value instanceof String) {</span>
                        Object o;

                        // we need to trigger multi image logic  in the  resource editor
<span class="nc bnc" id="L911" title="All 2 branches missed.">                        if (key.endsWith(&quot;Image&quot;)) {</span>
<span class="nc" id="L912">                            o = getImage((String) value);</span>
                        } else {
<span class="nc" id="L914">                            o = resources.get(value);</span>
                        }
<span class="nc bnc" id="L916" title="All 2 branches missed.">                        if (o == null) {</span>
<span class="nc" id="L917">                            throw new IllegalArgumentException(&quot;Theme entry for &quot; + key + &quot; could not be found: &quot; + value);</span>
                        }
<span class="nc" id="L919">                        h.put(key, o);</span>
                    }
                }
                // if this is a border we might need to do additional work for older versions
                // of Codename One and for the case of an image border where the images might not have
                // been loaded yet when the border was created
<span class="nc bnc" id="L925" title="All 2 branches missed.">                if (key.endsWith(&quot;order&quot;)) {</span>
<span class="nc" id="L926">                    Border b = confirmBorder(h, key);</span>
<span class="nc" id="L927">                    h.put(key, b);</span>
                }
<span class="nc" id="L929">            }</span>
<span class="nc" id="L930">            h.remove(&quot;uninitialized&quot;);</span>
        }
<span class="nc" id="L932">        return h;</span>
    }

    private Border confirmBorder(Hashtable h, String key) {
<span class="nc" id="L936">        Object val = h.get(key);</span>
<span class="nc bnc" id="L937" title="All 2 branches missed.">        if (val == null) {</span>
<span class="nc" id="L938">            return null;</span>
        }
<span class="nc bnc" id="L940" title="All 2 branches missed.">        if (!(val instanceof Border)) {</span>
<span class="nc" id="L941">            String[] value = (String[]) val;</span>
<span class="nc bnc" id="L942" title="All 2 branches missed.">            if (value == null) {</span>
<span class="nc" id="L943">                throw new IllegalArgumentException(&quot;Couldn't find resource: &quot; + key);</span>
            }

            // the resource was not already loaded when we loaded the theme
            // it must be loaded now so we can resolve the temporary name
<span class="nc" id="L948">            Border imageBorder = createImageBorder(value);</span>
<span class="nc" id="L949">            return imageBorder;</span>
        }
<span class="nc" id="L951">        return (Border) val;</span>
    }

    private Border createImageBorder(String[] value) {
<span class="nc bnc" id="L955" title="All 2 branches missed.">        if (value[0].equals(&quot;h&quot;)) {</span>
<span class="nc" id="L956">            return Border.createHorizonalImageBorder(getImage(value[1]),</span>
<span class="nc" id="L957">                    getImage(value[2]), getImage(value[3]));</span>
        }
<span class="nc bnc" id="L959" title="All 2 branches missed.">        if (value[0].equals(&quot;v&quot;)) {</span>
<span class="nc" id="L960">            return Border.createVerticalImageBorder(getImage(value[1]),</span>
<span class="nc" id="L961">                    getImage(value[2]), getImage(value[3]));</span>
        }
<span class="nc bnc" id="L963" title="All 2 branches missed.">        if (value[0].equals(&quot;s&quot;)) {</span>
<span class="nc" id="L964">            Image[] images = new Image[value.length - 1];</span>
<span class="nc" id="L965">            int ilen = images.length;</span>
<span class="nc bnc" id="L966" title="All 2 branches missed.">            for (int iter = 0; iter &lt; ilen; iter++) {</span>
<span class="nc" id="L967">                images[iter] = getImage(value[iter + 1]);</span>
            }
<span class="nc" id="L969">            return Border.createImageScaledBorder(images[0], images[1], images[2],</span>
                    images[3], images[4], images[5], images[6], images[7], images[8]);
        }
<span class="nc" id="L972">        Image[] images = new Image[value.length];</span>
<span class="nc" id="L973">        int vlen = value.length;</span>
<span class="nc bnc" id="L974" title="All 2 branches missed.">        for (int iter = 0; iter &lt; vlen; iter++) {</span>
<span class="nc" id="L975">            images[iter] = getImage(value[iter]);</span>
        }
<span class="nc bnc" id="L977" title="All 4 branches missed.">        switch (images.length) {</span>
            case 2:
<span class="nc" id="L979">                return Border.createImageBorder(images[0], images[1], null);</span>
            case 3:
<span class="nc" id="L981">                return Border.createImageBorder(images[0], images[1], images[2]);</span>
            case 8:
<span class="nc" id="L983">                return Border.createImageBorder(images[0], images[1], images[2],</span>
                        images[3], images[4], images[5], images[6], images[7], null);
            default:
<span class="nc" id="L986">                return Border.createImageBorder(images[0], images[1], images[2],</span>
                        images[3], images[4], images[5], images[6], images[7], images[8]);
        }
    }

    Object getResourceObject(String res) {
<span class="nc" id="L992">        return resources.get(res);</span>
    }

    Image createImage() throws IOException {
<span class="nc" id="L996">        return createImage(input);</span>
    }

    Image createImage(DataInputStream input) throws IOException {
<span class="nc bnc" id="L1000" title="All 4 branches missed.">        if (majorVersion == 0 &amp;&amp; minorVersion == 0) {</span>
<span class="nc" id="L1001">            byte[] data = new byte[input.readInt()];</span>
<span class="nc" id="L1002">            input.readFully(data, 0, data.length);</span>
<span class="nc" id="L1003">            return EncodedImage.create(data);</span>
        } else {
<span class="nc" id="L1005">            int type = input.readByte() &amp; 0xff;</span>
<span class="nc bnc" id="L1006" title="All 7 branches missed.">            switch (type) {</span>
                // PNG file
                case 0xf1:

                    // JPEG File
                case 0xf2:
<span class="nc" id="L1012">                    byte[] data = new byte[input.readInt()];</span>
<span class="nc" id="L1013">                    input.readFully(data, 0, data.length);</span>
<span class="nc bnc" id="L1014" title="All 2 branches missed.">                    if (minorVersion &gt; 3) {</span>
<span class="nc" id="L1015">                        int width = input.readInt();</span>
<span class="nc" id="L1016">                        int height = input.readInt();</span>
<span class="nc" id="L1017">                        boolean opaque = input.readBoolean();</span>
<span class="nc" id="L1018">                        return EncodedImage.create(data, width, height, opaque);</span>
                    }
<span class="nc" id="L1020">                    return EncodedImage.create(data);</span>

                // Indexed image
                case 0xF3:
<span class="nc" id="L1024">                    return createPackedImage8();</span>

                // SVG
                case 0xF5: {
<span class="nc" id="L1028">                    int svgSize = input.readInt();</span>
<span class="nc bnc" id="L1029" title="All 2 branches missed.">                    if (Image.isSVGSupported()) {</span>
<span class="nc" id="L1030">                        byte[] s = new byte[svgSize];</span>
<span class="nc" id="L1031">                        input.readFully(s);</span>
<span class="nc" id="L1032">                        String baseURL = input.readUTF();</span>
<span class="nc" id="L1033">                        boolean animated = input.readBoolean();</span>
<span class="nc" id="L1034">                        loadSVGRatios(input);</span>
<span class="nc" id="L1035">                        byte[] fallback = new byte[input.readInt()];</span>
<span class="nc bnc" id="L1036" title="All 2 branches missed.">                        if (fallback.length &gt; 0) {</span>
<span class="nc" id="L1037">                            input.readFully(fallback, 0, fallback.length);</span>
                        }
<span class="nc" id="L1039">                        return Image.createSVG(baseURL, animated, s);</span>
                    } else {
<span class="nc" id="L1041">                        svgSize -= input.skip(svgSize);</span>
<span class="nc bnc" id="L1042" title="All 2 branches missed.">                        while (svgSize &gt; 0) {</span>
<span class="nc" id="L1043">                            svgSize -= input.skip(svgSize);</span>
                        }
                        // read the base url, the animated property and screen ratios to skip them as well...
<span class="nc" id="L1046">                        input.readUTF();</span>
<span class="nc" id="L1047">                        input.readBoolean();</span>
<span class="nc" id="L1048">                        input.readFloat();</span>
<span class="nc" id="L1049">                        input.readFloat();</span>

<span class="nc" id="L1051">                        byte[] fallback = new byte[input.readInt()];</span>
<span class="nc" id="L1052">                        input.readFully(fallback, 0, fallback.length);</span>
<span class="nc" id="L1053">                        return EncodedImage.create(fallback);</span>
                    }
                }

                // SVG with multi-image
                case 0xf7: {
<span class="nc" id="L1059">                    int svgSize = input.readInt();</span>
<span class="nc bnc" id="L1060" title="All 2 branches missed.">                    if (Image.isSVGSupported()) {</span>
<span class="nc" id="L1061">                        byte[] s = new byte[svgSize];</span>
<span class="nc" id="L1062">                        input.readFully(s);</span>
<span class="nc" id="L1063">                        input.readUTF();</span>
<span class="nc" id="L1064">                        boolean animated = input.readBoolean();</span>
<span class="nc" id="L1065">                        Image img = readMultiImage(input, true);</span>
<span class="nc" id="L1066">                        Image svg = createSVG(animated, s);</span>
<span class="nc bnc" id="L1067" title="All 2 branches missed.">                        if (svg.getSVGDocument() == null) {</span>
<span class="nc" id="L1068">                            return img;</span>
                        }
<span class="nc" id="L1070">                        return svg;</span>
                    } else {
<span class="nc" id="L1072">                        svgSize -= input.skip(svgSize);</span>
<span class="nc bnc" id="L1073" title="All 2 branches missed.">                        while (svgSize &gt; 0) {</span>
<span class="nc" id="L1074">                            svgSize -= input.skip(svgSize);</span>
                        }
<span class="nc" id="L1076">                        String baseURL = input.readUTF();</span>

                        // read the animated property to skip it as well...
<span class="nc" id="L1079">                        input.readBoolean();</span>
<span class="nc" id="L1080">                        return readMultiImage(input);</span>
                    }
                }

                // mutli image
                case 0xF6:
<span class="nc" id="L1086">                    return readMultiImage(input);</span>

                case 0xEF:
<span class="nc" id="L1089">                    Timeline tl = readTimeline(input);</span>
<span class="nc" id="L1090">                    return tl;</span>

                // Fail this is the wrong data type
                default:
<span class="nc" id="L1094">                    throw new IOException(&quot;Illegal type while creating image: &quot; + Integer.toHexString(type));</span>
            }
        }
    }

    com.codename1.ui.Image createSVG(boolean animated, byte[] data) throws IOException {
<span class="nc" id="L1100">        return Image.createSVG(null, animated, data);</span>
    }

    private Image readMultiImage(DataInputStream input) throws IOException {
<span class="nc" id="L1104">        return readMultiImage(input, false);</span>
    }

    Image readMultiImage(DataInputStream input, boolean skipAll) throws IOException {
<span class="nc" id="L1108">        EncodedImage resultImage = null;</span>
<span class="nc bnc" id="L1109" title="All 2 branches missed.">        if (dpi == -1) {</span>
<span class="nc" id="L1110">            dpi = Display.getInstance().getDeviceDensity();</span>
        }
<span class="nc" id="L1112">        int dpiCount = input.readInt();</span>
<span class="nc" id="L1113">        int bestFitOffset = 0;</span>
<span class="nc" id="L1114">        int bestFitDPI = 0;</span>
<span class="nc" id="L1115">        int[] lengths = new int[dpiCount];</span>
<span class="nc" id="L1116">        int[] dpis = new int[dpiCount];</span>
<span class="nc" id="L1117">        boolean found = false;</span>
<span class="nc bnc" id="L1118" title="All 2 branches missed.">        for (int iter = 0; iter &lt; dpiCount; iter++) {</span>
<span class="nc" id="L1119">            int currentDPI = input.readInt();</span>
<span class="nc" id="L1120">            lengths[iter] = input.readInt();</span>
<span class="nc" id="L1121">            dpis[iter] = currentDPI;</span>
<span class="nc bnc" id="L1122" title="All 6 branches missed.">            if (bestFitDPI != dpi &amp;&amp; dpi &gt;= currentDPI &amp;&amp; currentDPI &gt;= bestFitDPI) {</span>
<span class="nc" id="L1123">                bestFitDPI = currentDPI;</span>
<span class="nc" id="L1124">                bestFitOffset = iter;</span>
<span class="nc" id="L1125">                found = true;</span>
            }
        }
<span class="nc bnc" id="L1128" title="All 2 branches missed.">        if (!found) {</span>
            // special case for low DPI devices when running with high resolution resources
            // we want to pick the loweset resolution possible
<span class="nc" id="L1131">            bestFitDPI = dpis[0];</span>
<span class="nc" id="L1132">            bestFitOffset = 0;</span>
<span class="nc bnc" id="L1133" title="All 2 branches missed.">            for (int iter = 1; iter &lt; dpiCount; iter++) {</span>
<span class="nc bnc" id="L1134" title="All 2 branches missed.">                if (dpis[iter] &lt; bestFitDPI) {</span>
<span class="nc" id="L1135">                    bestFitDPI = dpis[iter];</span>
<span class="nc" id="L1136">                    bestFitOffset = iter;</span>
                }
            }
        }

<span class="nc bnc" id="L1141" title="All 4 branches missed.">        if (runtimeMultiImages &amp;&amp; !skipAll) {</span>
<span class="nc" id="L1142">            byte[][] data = new byte[dpiCount][];</span>
<span class="nc bnc" id="L1143" title="All 2 branches missed.">            for (int iter = 0; iter &lt; lengths.length; iter++) {</span>
<span class="nc" id="L1144">                int size = lengths[iter];</span>
<span class="nc" id="L1145">                data[iter] = new byte[size];</span>
<span class="nc" id="L1146">                input.readFully(data[iter], 0, size);</span>
            }
<span class="nc" id="L1148">            return EncodedImage.createMulti(dpis, data);</span>
        } else {
<span class="nc bnc" id="L1150" title="All 2 branches missed.">            for (int iter = 0; iter &lt; lengths.length; iter++) {</span>
<span class="nc" id="L1151">                int size = lengths[iter];</span>
<span class="nc bnc" id="L1152" title="All 4 branches missed.">                if (!skipAll &amp;&amp; bestFitOffset == iter) {</span>
<span class="nc" id="L1153">                    byte[] multiImageData = new byte[size];</span>
<span class="nc" id="L1154">                    input.readFully(multiImageData, 0, size);</span>
<span class="nc" id="L1155">                    resultImage = EncodedImage.create(multiImageData);</span>
<span class="nc" id="L1156">                } else {</span>
<span class="nc bnc" id="L1157" title="All 2 branches missed.">                    while (size &gt; 0) {</span>
<span class="nc" id="L1158">                        size -= input.skip(size);</span>
                    }
                }
            }
        }

<span class="nc" id="L1164">        return resultImage;</span>
    }

    void loadSVGRatios(DataInputStream input) throws IOException {
<span class="nc" id="L1168">        input.readFloat();</span>
<span class="nc" id="L1169">        input.readFloat();</span>
<span class="nc" id="L1170">    }</span>

    private byte[] createData() throws IOException {
<span class="fc" id="L1173">        byte[] data = new byte[input.readInt()];</span>
<span class="fc" id="L1174">        input.readFully(data);</span>
<span class="fc" id="L1175">        return data;</span>
    }

    Font loadFont(DataInputStream input, String id, boolean packed) throws IOException {
<span class="nc bnc" id="L1179" title="All 4 branches missed.">        if (majorVersion == 0 &amp;&amp; minorVersion == 0) {</span>
            Image bitmap;
<span class="nc bnc" id="L1181" title="All 2 branches missed.">            if (packed) {</span>
<span class="nc" id="L1182">                bitmap = createPackedImage8();</span>
            } else {
<span class="nc" id="L1184">                bitmap = createImage(input);</span>
            }
<span class="nc" id="L1186">            int charCount = input.readShort();</span>
<span class="nc" id="L1187">            int[] cutOffsets = new int[charCount];</span>
<span class="nc" id="L1188">            int[] charWidth = new int[charCount];</span>
<span class="nc bnc" id="L1189" title="All 2 branches missed.">            for (int iter = 0; iter &lt; charCount; iter++) {</span>
<span class="nc" id="L1190">                cutOffsets[iter] = input.readShort();</span>
<span class="nc" id="L1191">                charWidth[iter] = input.readByte();</span>
            }
<span class="nc" id="L1193">            String charset = input.readUTF();</span>
<span class="nc" id="L1194">            Font old = Font.getBitmapFont(id);</span>
<span class="nc bnc" id="L1195" title="All 2 branches missed.">            if (old != null) {</span>
<span class="nc" id="L1196">                return old;</span>
            }
<span class="nc" id="L1198">            return Font.createBitmapFont(id, bitmap, cutOffsets, charWidth, charset);</span>
        }

        // read a system font fallback
<span class="nc" id="L1202">        int fallback = input.readByte() &amp; 0xff;</span>

        // do we have an emedded truetype font? Do we support embedded fonts?
<span class="nc" id="L1205">        boolean trueTypeIncluded = input.readBoolean();</span>
<span class="nc" id="L1206">        Font font = null;</span>
        /*if(trueTypeIncluded) {
            int size = input.readInt();
            if(Font.isTrueTypeFileSupported()) {
                font = Font.createTrueTypeFont(input);
            } else {
                while(size &gt; 0) {
                    size -= input.skip(size);
                }
            }
        }*/
<span class="nc" id="L1217">        boolean lookupIncluded = input.readBoolean();</span>
<span class="nc bnc" id="L1218" title="All 2 branches missed.">        if (lookupIncluded) {</span>
<span class="nc" id="L1219">            String lookup = input.readUTF();</span>
<span class="nc bnc" id="L1220" title="All 4 branches missed.">            if (font == null &amp;&amp; Font.isCreationByStringSupported()) {</span>
<span class="nc" id="L1221">                font = Font.create(lookup);</span>
            }
        }
<span class="nc" id="L1224">        boolean bitmapIncluded = input.readBoolean();</span>
<span class="nc bnc" id="L1225" title="All 2 branches missed.">        if (bitmapIncluded) {</span>
<span class="nc" id="L1226">            font = loadBitmapFont(input, id, font);</span>
        }
<span class="nc bnc" id="L1228" title="All 2 branches missed.">        if (font != null) {</span>
<span class="nc" id="L1229">            return font;</span>
        }
<span class="nc" id="L1231">        return Font.createSystemFont(fallback &amp; (Font.FACE_MONOSPACE | Font.FACE_PROPORTIONAL | Font.FACE_SYSTEM),</span>
                fallback &amp; (Font.STYLE_BOLD | Font.STYLE_ITALIC | Font.STYLE_PLAIN | Font.STYLE_UNDERLINED),
                fallback &amp; (Font.SIZE_LARGE | Font.SIZE_MEDIUM | Font.SIZE_SMALL));
    }

    void readRenderingHint(DataInputStream i) throws IOException {
<span class="nc" id="L1237">        i.readByte();</span>
<span class="nc" id="L1238">    }</span>

    Font loadBitmapFont(DataInputStream input, String id, com.codename1.ui.Font font) throws IOException {
<span class="nc" id="L1241">        Image bitmap = createImage(input);</span>
<span class="nc" id="L1242">        int charCount = input.readShort();</span>
<span class="nc" id="L1243">        int[] cutOffsets = new int[charCount];</span>
<span class="nc" id="L1244">        int[] charWidth = new int[charCount];</span>
<span class="nc bnc" id="L1245" title="All 2 branches missed.">        for (int iter = 0; iter &lt; charCount; iter++) {</span>
<span class="nc" id="L1246">            cutOffsets[iter] = input.readShort();</span>
        }
<span class="nc bnc" id="L1248" title="All 2 branches missed.">        for (int iter = 0; iter &lt; charCount; iter++) {</span>
<span class="nc" id="L1249">            charWidth[iter] = input.readByte();</span>
        }
<span class="nc" id="L1251">        String charset = input.readUTF();</span>
<span class="nc" id="L1252">        readRenderingHint(input);</span>
<span class="nc bnc" id="L1253" title="All 2 branches missed.">        if (font == null) {</span>
<span class="nc bnc" id="L1254" title="All 2 branches missed.">            if (Font.isBitmapFontEnabled()) {</span>
<span class="nc" id="L1255">                Font old = Font.getBitmapFont(id);</span>
<span class="nc bnc" id="L1256" title="All 2 branches missed.">                if (old != null) {</span>
                    // Returning bitmap font from cache, to prevent collision with an
                    // old resource file use Font.clearBitmapCache()
<span class="nc" id="L1259">                    return old;</span>
                }
<span class="nc" id="L1261">                return Font.createBitmapFont(id, bitmap, cutOffsets, charWidth, charset);</span>
            }
        }
<span class="nc" id="L1264">        return font;</span>
    }

    Font createTrueTypeFont(Font f, String fontName, String fileName, float fontSize, int sizeSetting) {
<span class="nc bnc" id="L1268" title="All 11 branches missed.">        switch (sizeSetting) {</span>
            case 0: // small
<span class="nc" id="L1270">                fontSize = Font.createSystemFont(Font.FACE_SYSTEM, Font.STYLE_PLAIN, Font.SIZE_SMALL).getHeight();</span>
<span class="nc" id="L1271">                break;</span>
            case 1: // medium
<span class="nc" id="L1273">                fontSize = Font.createSystemFont(Font.FACE_SYSTEM, Font.STYLE_PLAIN, Font.SIZE_MEDIUM).getHeight();</span>
<span class="nc" id="L1274">                break;</span>
            case 2: // large
<span class="nc" id="L1276">                fontSize = Font.createSystemFont(Font.FACE_SYSTEM, Font.STYLE_PLAIN, Font.SIZE_LARGE).getHeight();</span>
<span class="nc" id="L1277">                break;</span>
            case 3: // millimetres
<span class="nc" id="L1279">                fontSize = Display.getInstance().convertToPixels((int) (fontSize * 10), true) / 10.0f;</span>
<span class="nc" id="L1280">                break;</span>

            case 4: // pixels
<span class="nc" id="L1283">                break;</span>
            case 5: // rem
<span class="nc" id="L1285">                fontSize = Font.getDefaultFont().getHeight() * fontSize;</span>
<span class="nc" id="L1286">                break;</span>
            case 6: // vw
<span class="nc" id="L1288">                fontSize = CN.getDisplayWidth() * fontSize / 100f;</span>
<span class="nc" id="L1289">                break;</span>
            case 7: // vh
<span class="nc" id="L1291">                fontSize = CN.getDisplayHeight() * fontSize / 100f;</span>
<span class="nc" id="L1292">                break;</span>
            case 8: // vmin
<span class="nc" id="L1294">                fontSize = Math.min(CN.getDisplayWidth(), CN.getDisplayHeight()) * fontSize / 100f;</span>
<span class="nc" id="L1295">                break;</span>
            case 9: // vmax
<span class="nc" id="L1297">                fontSize = Math.max(CN.getDisplayWidth(), CN.getDisplayHeight()) * fontSize / 100f;</span>
                break;
        }
<span class="nc bnc" id="L1300" title="All 2 branches missed.">        if (!failOnMissingTruetype) {</span>
            try {
<span class="nc" id="L1302">                Font ttf = Font.createTrueTypeFont(fontName, fileName);</span>
<span class="nc bnc" id="L1303" title="All 2 branches missed.">                if (ttf != null) {</span>
<span class="nc" id="L1304">                    return ttf.derive(fontSize, f.getStyle());</span>
                }
<span class="nc" id="L1306">                return f;</span>
<span class="nc" id="L1307">            } catch (Exception ex) {</span>
<span class="nc" id="L1308">                return f;</span>
            }
        }
<span class="nc" id="L1311">        return Font.createTrueTypeFont(fontName, fileName).derive(fontSize, f.getStyle());</span>
    }

    Hashtable loadTheme(String id, boolean newerVersion) throws IOException {
<span class="nc" id="L1315">        Hashtable theme = new Hashtable();</span>
<span class="nc" id="L1316">        String densityStr = Display.getInstance().getDensityStr();</span>
<span class="nc" id="L1317">        String platformName = Display.getInstance().getPlatformName();</span>
<span class="nc bnc" id="L1318" title="All 2 branches missed.">        if (&quot;HTML5&quot;.equals(platformName)) {</span>
<span class="nc" id="L1319">            platformName = Display.getInstance().getProperty(&quot;HTML5.platformName&quot;, &quot;mac&quot;);</span>
        }
<span class="nc bnc" id="L1321" title="All 4 branches missed.">        String deviceType = Display.getInstance().isDesktop() ? &quot;desktop&quot; : Display.getInstance().isTablet() ? &quot;tablet&quot; : &quot;phone&quot;;</span>
<span class="nc" id="L1322">        String platformPrefix = &quot;platform-&quot; + platformName + &quot;-&quot;;</span>
<span class="nc" id="L1323">        String densityPrefix = &quot;density-&quot; + densityStr + &quot;-&quot;;</span>
<span class="nc" id="L1324">        String devicePrefix = &quot;device-&quot; + deviceType + &quot;-&quot;;</span>
<span class="nc" id="L1325">        theme.put(&quot;name&quot;, id);</span>

        // marks the theme as uninitialized so we can finish &quot;wiring&quot; cached resources
<span class="nc" id="L1328">        theme.put(&quot;uninitialized&quot;, Boolean.TRUE);</span>
<span class="nc" id="L1329">        int size = input.readShort();</span>
<span class="nc" id="L1330">        List&lt;String&gt; fontKeys = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L1331">        Map&lt;String, Float&gt; fontScaleRules = null;</span>
<span class="nc" id="L1332">        class MediaRule {</span>
            int matchCount;
            int bestMatchScore;
            String rawKey;
            String translatedKey;


        }
<span class="nc" id="L1340">        Map&lt;String, MediaRule&gt; mediaRules = new HashMap&lt;String, MediaRule&gt;();</span>
<span class="nc" id="L1341">        int defaultFontSizeSetPriority = 0;</span>
<span class="nc bnc" id="L1342" title="All 2 branches missed.">        for (int iter = 0; iter &lt; size; iter++) {</span>
<span class="nc" id="L1343">            String key = input.readUTF();</span>
<span class="nc bnc" id="L1344" title="All 2 branches missed.">            if (key.startsWith(&quot;@&quot;)) {</span>
<span class="nc" id="L1345">                theme.put(key, input.readUTF());</span>
<span class="nc bnc" id="L1346" title="All 2 branches missed.">                if (enableMediaQueries) {</span>
<span class="nc bnc" id="L1347" title="All 2 branches missed.">                    if (key.endsWith(&quot;-font-scale&quot;)) {</span>
<span class="nc bnc" id="L1348" title="All 2 branches missed.">                        if (fontScaleRules == null) {</span>
<span class="nc" id="L1349">                            fontScaleRules = new LinkedHashMap&lt;String, Float&gt;();</span>
                        }
<span class="nc" id="L1351">                        fontScaleRules.put(key, Float.parseFloat((String) theme.get(key)));</span>
                    }
                }
<span class="nc bnc" id="L1354" title="All 4 branches missed.">                if (key.equals(&quot;@defaultFontSizeInt&quot;) &amp;&amp; defaultFontSizeSetPriority &lt; 1) {</span>
<span class="nc" id="L1355">                    int themeMedianFontSize = Integer.parseInt((String) theme.get(key));</span>
<span class="nc bnc" id="L1356" title="All 2 branches missed.">                    if (themeMedianFontSize &gt; 0) {</span>
<span class="nc bnc" id="L1357" title="All 2 branches missed.">                        double adjustedFontSize = themeMedianFontSize * CN.convertToPixels(1f) * 25.4 / (CN.isDesktop() ? 96f : 160f);</span>
<span class="nc" id="L1358">                        Font.setDefaultFont(Font.createTrueTypeFont(Font.NATIVE_MAIN_REGULAR, (float) adjustedFontSize / CN.convertToPixels(1f)));</span>
<span class="nc" id="L1359">                        defaultFontSizeSetPriority = 1;</span>
                    }
                }
<span class="nc bnc" id="L1362" title="All 6 branches missed.">                if (CN.isTablet() &amp;&amp; key.equals(&quot;@defaultTabletFontSizeInt&quot;) &amp;&amp; defaultFontSizeSetPriority &lt; 2) {</span>
<span class="nc" id="L1363">                    int themeMedianFontSize = Integer.parseInt((String) theme.get(key));</span>
<span class="nc bnc" id="L1364" title="All 2 branches missed.">                    if (themeMedianFontSize &gt; 0) {</span>
<span class="nc bnc" id="L1365" title="All 2 branches missed.">                        double adjustedFontSize = themeMedianFontSize * CN.convertToPixels(1f) * 25.4 / (CN.isDesktop() ? 96f : 160f);</span>
<span class="nc" id="L1366">                        Font.setDefaultFont(Font.createTrueTypeFont(Font.NATIVE_MAIN_REGULAR, (float) adjustedFontSize / CN.convertToPixels(1f)));</span>
<span class="nc" id="L1367">                        defaultFontSizeSetPriority = 2;</span>
                    }
                }
<span class="nc bnc" id="L1370" title="All 6 branches missed.">                if (CN.isDesktop() &amp;&amp; key.equals(&quot;@defaultDesktopFontSizeInt&quot;) &amp;&amp; defaultFontSizeSetPriority &lt; 3) {</span>
<span class="nc" id="L1371">                    int themeMedianFontSize = Integer.parseInt((String) theme.get(key));</span>
<span class="nc bnc" id="L1372" title="All 2 branches missed.">                    if (themeMedianFontSize &gt; 0) {</span>
<span class="nc bnc" id="L1373" title="All 2 branches missed.">                        double adjustedFontSize = themeMedianFontSize * CN.convertToPixels(1f) * 25.4 / (CN.isDesktop() ? 96f : 160f);</span>
<span class="nc" id="L1374">                        Font.setDefaultFont(Font.createTrueTypeFont(Font.NATIVE_MAIN_REGULAR, (float) adjustedFontSize / CN.convertToPixels(1f)));</span>
<span class="nc" id="L1375">                        defaultFontSizeSetPriority = 3;</span>
                    }
<span class="nc" id="L1377">                }</span>
                continue;
            }
<span class="nc bnc" id="L1380" title="All 2 branches missed.">            if (enableMediaQueries) {</span>
<span class="nc" id="L1381">                String subkey = key;</span>
<span class="nc" id="L1382">                boolean mediaMatch = true;</span>
<span class="nc" id="L1383">                int matchCount = 0;</span>
<span class="nc" id="L1384">                int bestMatchScore = 0;</span>
<span class="nc bnc" id="L1385" title="All 2 branches missed.">                if (subkey.startsWith(&quot;device-&quot;)) {</span>
<span class="nc bnc" id="L1386" title="All 2 branches missed.">                    if (!subkey.startsWith(devicePrefix)) {</span>
<span class="nc" id="L1387">                        mediaMatch = false;</span>
                    } else {
<span class="nc" id="L1389">                        subkey = subkey.substring(devicePrefix.length());</span>
<span class="nc" id="L1390">                        matchCount++;</span>
<span class="nc" id="L1391">                        bestMatchScore = Math.max(50, bestMatchScore);</span>
                    }

                }
<span class="nc bnc" id="L1395" title="All 4 branches missed.">                if (mediaMatch &amp;&amp; subkey.startsWith(&quot;platform-&quot;)) {</span>
<span class="nc bnc" id="L1396" title="All 2 branches missed.">                    if (!subkey.startsWith(platformPrefix)) {</span>
<span class="nc" id="L1397">                        mediaMatch = false;</span>
                    } else {
<span class="nc" id="L1399">                        subkey = subkey.substring(platformPrefix.length());</span>
<span class="nc" id="L1400">                        matchCount++;</span>
<span class="nc" id="L1401">                        bestMatchScore = Math.max(100, bestMatchScore);</span>
                    }
                }
<span class="nc bnc" id="L1404" title="All 4 branches missed.">                if (mediaMatch &amp;&amp; subkey.startsWith(&quot;density-&quot;)) {</span>
<span class="nc bnc" id="L1405" title="All 2 branches missed.">                    if (!subkey.startsWith(densityPrefix)) {</span>
<span class="nc" id="L1406">                        mediaMatch = false;</span>
                    } else {
<span class="nc" id="L1408">                        subkey = subkey.substring(densityPrefix.length());</span>
<span class="nc" id="L1409">                        matchCount++;</span>
<span class="nc" id="L1410">                        bestMatchScore = Math.max(10, bestMatchScore);</span>
                    }
                }

<span class="nc bnc" id="L1414" title="All 2 branches missed.">                if (mediaMatch) {</span>
<span class="nc bnc" id="L1415" title="All 2 branches missed.">                    if (mediaRules == null) {</span>
<span class="nc" id="L1416">                        mediaRules = new HashMap&lt;String, MediaRule&gt;();</span>
                    }
<span class="nc" id="L1418">                    MediaRule rule = mediaRules.get(subkey);</span>
<span class="nc bnc" id="L1419" title="All 2 branches missed.">                    boolean replace = rule == null;</span>
<span class="nc bnc" id="L1420" title="All 4 branches missed.">                    if (!replace &amp;&amp; rule.matchCount &lt;= matchCount) {</span>
<span class="nc" id="L1421">                        replace = true;</span>
                    }
<span class="nc bnc" id="L1423" title="All 4 branches missed.">                    if (!replace &amp;&amp; rule.bestMatchScore &lt;= bestMatchScore) {</span>
<span class="nc" id="L1424">                        replace = true;</span>
                    }
<span class="nc bnc" id="L1426" title="All 2 branches missed.">                    if (replace) {</span>
<span class="nc bnc" id="L1427" title="All 2 branches missed.">                        if (rule == null) {</span>
<span class="nc" id="L1428">                            rule = new MediaRule();</span>
<span class="nc" id="L1429">                            mediaRules.put(subkey, rule);</span>
                        }
<span class="nc" id="L1431">                        rule.bestMatchScore = bestMatchScore;</span>
<span class="nc" id="L1432">                        rule.matchCount = matchCount;</span>
<span class="nc" id="L1433">                        rule.rawKey = key;</span>
<span class="nc" id="L1434">                        rule.translatedKey = subkey;</span>
                    }

                }

            }
            // if this is a simple numeric value
<span class="nc bnc" id="L1441" title="All 2 branches missed.">            if (key.endsWith(&quot;Color&quot;)) {</span>

<span class="nc" id="L1443">                theme.put(key, Integer.toHexString(input.readInt()));</span>
<span class="nc" id="L1444">                continue;</span>
            }

<span class="nc bnc" id="L1447" title="All 4 branches missed.">            if (key.endsWith(&quot;align&quot;) || key.endsWith(&quot;textDecoration&quot;)) {</span>
<span class="nc" id="L1448">                theme.put(key, Integer.valueOf(input.readShort()));</span>
<span class="nc" id="L1449">                continue;</span>
            }

            // if this is a short numeric value for transparency
<span class="nc bnc" id="L1453" title="All 2 branches missed.">            if (key.endsWith(&quot;ransparency&quot;)) {</span>
<span class="nc" id="L1454">                theme.put(key, &quot;&quot; + (input.readByte() &amp; 0xff));</span>
<span class="nc" id="L1455">                continue;</span>
            }

<span class="nc bnc" id="L1458" title="All 2 branches missed.">            if (key.endsWith(&quot;fgAlpha&quot;)) {</span>
<span class="nc" id="L1459">                theme.put(key, (input.readInt() &amp; 0xff));</span>
<span class="nc" id="L1460">                continue;</span>
            }
<span class="nc bnc" id="L1462" title="All 2 branches missed.">            if (key.endsWith(&quot;opacity&quot;)) {</span>
<span class="nc" id="L1463">                theme.put(key, &quot;&quot; + (input.readInt() &amp; 0xff));</span>
<span class="nc" id="L1464">                continue;</span>
            }

<span class="nc bnc" id="L1467" title="All 2 branches missed.">            if (key.endsWith(&quot;elevation&quot;)) {</span>
<span class="nc" id="L1468">                theme.put(key, (input.readInt() &amp; 0xff));</span>
<span class="nc" id="L1469">                continue;</span>
            }

<span class="nc bnc" id="L1472" title="All 2 branches missed.">            if (key.endsWith(&quot;iconGap&quot;)) {</span>
<span class="nc" id="L1473">                theme.put(key, input.readFloat());</span>
<span class="nc" id="L1474">                continue;</span>
            }

<span class="nc bnc" id="L1477" title="All 2 branches missed.">            if (key.endsWith(&quot;iconGapUnit&quot;)) {</span>
<span class="nc" id="L1478">                theme.put(key, input.readByte());</span>
<span class="nc" id="L1479">                continue;</span>
            }

<span class="nc bnc" id="L1482" title="All 2 branches missed.">            if (key.endsWith(&quot;surface&quot;)) {</span>
<span class="nc" id="L1483">                theme.put(key, (input.readBoolean()));</span>
<span class="nc" id="L1484">                continue;</span>
            }

            // if this is a padding or margin then we will have the 4 values as bytes
<span class="nc bnc" id="L1488" title="All 4 branches missed.">            if (key.endsWith(&quot;adding&quot;) || key.endsWith(&quot;argin&quot;)) {</span>
<span class="nc bnc" id="L1489" title="All 2 branches missed.">                if (minorVersion &gt; 7) {</span>
<span class="nc" id="L1490">                    float p1 = input.readFloat();</span>
<span class="nc" id="L1491">                    float p2 = input.readFloat();</span>
<span class="nc" id="L1492">                    float p3 = input.readFloat();</span>
<span class="nc" id="L1493">                    float p4 = input.readFloat();</span>
<span class="nc" id="L1494">                    theme.put(key, &quot;&quot; + p1 + &quot;,&quot; + p2 + &quot;,&quot; + p3 + &quot;,&quot; + p4);</span>
<span class="nc" id="L1495">                } else {</span>
<span class="nc" id="L1496">                    int p1 = input.readByte() &amp; 0xff;</span>
<span class="nc" id="L1497">                    int p2 = input.readByte() &amp; 0xff;</span>
<span class="nc" id="L1498">                    int p3 = input.readByte() &amp; 0xff;</span>
<span class="nc" id="L1499">                    int p4 = input.readByte() &amp; 0xff;</span>
<span class="nc" id="L1500">                    theme.put(key, &quot;&quot; + p1 + &quot;,&quot; + p2 + &quot;,&quot; + p3 + &quot;,&quot; + p4);</span>
                }
<span class="nc" id="L1502">                continue;</span>
            }

            // padding and or margin type
<span class="nc bnc" id="L1506" title="All 2 branches missed.">            if (key.endsWith(&quot;Unit&quot;)) {</span>
<span class="nc" id="L1507">                byte p1 = input.readByte();</span>
<span class="nc" id="L1508">                byte p2 = input.readByte();</span>
<span class="nc" id="L1509">                byte p3 = input.readByte();</span>
<span class="nc" id="L1510">                byte p4 = input.readByte();</span>
<span class="nc" id="L1511">                theme.put(key, new byte[]{p1, p2, p3, p4});</span>
<span class="nc" id="L1512">                continue;</span>
            }

            // border
<span class="nc bnc" id="L1516" title="All 2 branches missed.">            if (key.endsWith(&quot;order&quot;)) {</span>
<span class="nc" id="L1517">                int borderType = input.readShort() &amp; 0xffff;</span>
<span class="nc" id="L1518">                Object b = createBorder(input, borderType);</span>
<span class="nc" id="L1519">                theme.put(key, b);</span>
<span class="nc" id="L1520">                continue;</span>
            }

            // if this is a font
<span class="nc bnc" id="L1524" title="All 2 branches missed.">            if (key.endsWith(&quot;ont&quot;)) {</span>
                Font f;

                // is this a new font?
<span class="nc bnc" id="L1528" title="All 2 branches missed.">                if (input.readBoolean()) {</span>
<span class="nc" id="L1529">                    String fontId = input.readUTF();</span>
<span class="nc" id="L1530">                    f = (Font) resources.get(fontId);</span>

                    // if the font is not yet loaded
<span class="nc bnc" id="L1533" title="All 2 branches missed.">                    if (f == null) {</span>
<span class="nc" id="L1534">                        theme.put(key, fontId);</span>
<span class="nc" id="L1535">                        continue;</span>
                    }
<span class="nc" id="L1537">                } else {</span>
<span class="nc" id="L1538">                    f = Font.createSystemFont(input.readByte(), input.readByte(), input.readByte());</span>
<span class="nc bnc" id="L1539" title="All 2 branches missed.">                    if (minorVersion &gt; 4) {</span>
<span class="nc" id="L1540">                        boolean hasTTF = input.readBoolean();</span>
<span class="nc bnc" id="L1541" title="All 2 branches missed.">                        if (hasTTF) {</span>
<span class="nc" id="L1542">                            String fileName = input.readUTF();</span>
<span class="nc" id="L1543">                            String fontName = input.readUTF();</span>
<span class="nc" id="L1544">                            int sizeSetting = input.readInt();</span>
<span class="nc" id="L1545">                            float fontSize = input.readFloat();</span>
<span class="nc bnc" id="L1546" title="All 2 branches missed.">                            if (Font.isTrueTypeFileSupported()) {</span>
<span class="nc" id="L1547">                                fontKeys.add(key);</span>
<span class="nc" id="L1548">                                f = createTrueTypeFont(f, fontName, fileName, fontSize, sizeSetting);</span>
                            }
                        }
                    }
                }
<span class="nc" id="L1553">                theme.put(key, f);</span>
<span class="nc" id="L1554">                continue;</span>
            }

            // the background property
<span class="nc bnc" id="L1558" title="All 2 branches missed.">            if (key.endsWith(&quot;ackground&quot;)) {</span>
<span class="nc" id="L1559">                int type = input.readByte() &amp; 0xff;</span>
<span class="nc" id="L1560">                int pos = key.indexOf('.');</span>
<span class="nc bnc" id="L1561" title="All 2 branches missed.">                if (pos &gt; -1) {</span>
<span class="nc" id="L1562">                    key = key.substring(0, pos);</span>
                } else {
<span class="nc" id="L1564">                    key = &quot;&quot;;</span>
                }
<span class="nc" id="L1566">                theme.put(key + Style.BACKGROUND_TYPE, Byte.valueOf((byte) type));</span>

<span class="nc bnc" id="L1568" title="All 5 branches missed.">                switch (type) {</span>
                    // Scaled Image
                    case 0xF1:
                        // Tiled Both Image
                    case MAGIC_INDEXED_IMAGE_LEGACY:
                        // the image name coupled with the type
<span class="nc" id="L1574">                        theme.put(key + Style.BG_IMAGE, input.readUTF());</span>
<span class="nc" id="L1575">                        break;</span>

                    // Aligned Image
                    case 0xf5:
                        // Tiled Vertically Image
                    case 0xF2:
                        // Tiled Horizontally Image
                    case 0xF3:
                        // the image name coupled with the type and with alignment information
<span class="nc" id="L1584">                        String imageName = input.readUTF();</span>
<span class="nc" id="L1585">                        theme.put(key + Style.BG_IMAGE, imageName);</span>
<span class="nc" id="L1586">                        byte align = input.readByte();</span>
<span class="nc" id="L1587">                        theme.put(key + Style.BACKGROUND_ALIGNMENT, Byte.valueOf(align));</span>
<span class="nc" id="L1588">                        break;</span>

                    // Horizontal Linear Gradient
                    case 0xF6:
                        // Vertical Linear Gradient
                    case 0xF7:
<span class="nc" id="L1594">                        Float c = new Float(0.5f);</span>
<span class="nc" id="L1595">                        theme.put(key + Style.BACKGROUND_GRADIENT, new Object[]{Integer.valueOf(input.readInt()), Integer.valueOf(input.readInt()), c, c, new Float(1)});</span>
<span class="nc" id="L1596">                        break;</span>

                    // Radial Gradient
                    case 0xF8:
<span class="nc" id="L1600">                        int c1 = input.readInt();</span>
<span class="nc" id="L1601">                        int c2 = input.readInt();</span>
<span class="nc" id="L1602">                        float f1 = input.readFloat();</span>
<span class="nc" id="L1603">                        float f2 = input.readFloat();</span>
<span class="nc" id="L1604">                        float radialSize = 1;</span>
<span class="nc bnc" id="L1605" title="All 2 branches missed.">                        if (minorVersion &gt; 1) {</span>
<span class="nc" id="L1606">                            radialSize = input.readFloat();</span>
                        }
<span class="nc" id="L1608">                        theme.put(key + Style.BACKGROUND_GRADIENT, new Object[]{Integer.valueOf(c1),</span>
<span class="nc" id="L1609">                                Integer.valueOf(c2),</span>
                                new Float(f1),
                                new Float(f2),
                                new Float(radialSize)});
                        break;
                }
<span class="nc" id="L1615">                continue;</span>
            }

            // if this is a background image bgImage
<span class="nc bnc" id="L1619" title="All 2 branches missed.">            if (key.endsWith(&quot;derive&quot;)) {</span>
<span class="nc" id="L1620">                theme.put(key, input.readUTF());</span>
<span class="nc" id="L1621">                continue;</span>
            }

            // if this is a background image bgImage
<span class="nc bnc" id="L1625" title="All 2 branches missed.">            if (key.endsWith(&quot;bgImage&quot;)) {</span>
<span class="nc" id="L1626">                String imageId = input.readUTF();</span>
<span class="nc" id="L1627">                Image i = getImage(imageId);</span>

                // if the font is not yet loaded
<span class="nc bnc" id="L1630" title="All 2 branches missed.">                if (i == null) {</span>
<span class="nc" id="L1631">                    theme.put(key, imageId);</span>
<span class="nc" id="L1632">                    continue;</span>
                }
<span class="nc" id="L1634">                theme.put(key, i);</span>
<span class="nc" id="L1635">                continue;</span>
            }

<span class="nc bnc" id="L1638" title="All 2 branches missed.">            if (key.endsWith(&quot;scaledImage&quot;)) {</span>
<span class="nc bnc" id="L1639" title="All 2 branches missed.">                if (input.readBoolean()) {</span>
<span class="nc" id="L1640">                    theme.put(key, &quot;true&quot;);</span>
                } else {
<span class="nc" id="L1642">                    theme.put(key, &quot;false&quot;);</span>
                }
<span class="nc" id="L1644">                continue;</span>
            }

<span class="nc bnc" id="L1647" title="All 4 branches missed.">            if (key.endsWith(Style.BACKGROUND_TYPE) || key.endsWith(Style.BACKGROUND_ALIGNMENT)) {</span>
<span class="nc" id="L1648">                theme.put(key, Byte.valueOf(input.readByte()));</span>
<span class="nc" id="L1649">                continue;</span>
            }

<span class="nc bnc" id="L1652" title="All 2 branches missed.">            if (key.endsWith(Style.BACKGROUND_GRADIENT)) {</span>
<span class="nc bnc" id="L1653" title="All 2 branches missed.">                if (minorVersion &lt; 2) {</span>
<span class="nc" id="L1654">                    theme.put(key, new Object[]{</span>
<span class="nc" id="L1655">                            Integer.valueOf(input.readInt()),</span>
<span class="nc" id="L1656">                            Integer.valueOf(input.readInt()),</span>
<span class="nc" id="L1657">                            new Float(input.readFloat()),</span>
<span class="nc" id="L1658">                            new Float(input.readFloat())</span>
                    });
                } else {
<span class="nc" id="L1661">                    theme.put(key, new Object[]{</span>
<span class="nc" id="L1662">                            Integer.valueOf(input.readInt()),</span>
<span class="nc" id="L1663">                            Integer.valueOf(input.readInt()),</span>
<span class="nc" id="L1664">                            new Float(input.readFloat()),</span>
<span class="nc" id="L1665">                            new Float(input.readFloat()),</span>
<span class="nc" id="L1666">                            new Float(input.readFloat())</span>
                    });
                }
<span class="nc" id="L1669">                continue;</span>
            }

            // thow an exception no idea what this is
<span class="nc" id="L1673">            throw new IOException(&quot;Error while trying to read theme property: &quot; + key);</span>
        }
<span class="nc bnc" id="L1675" title="All 2 branches missed.">        if (enableMediaQueries) {</span>
<span class="nc bnc" id="L1676" title="All 4 branches missed.">            if (mediaRules != null &amp;&amp; !mediaRules.isEmpty()) {</span>
<span class="nc bnc" id="L1677" title="All 2 branches missed.">                for (MediaRule rule : mediaRules.values()) {</span>
<span class="nc" id="L1678">                    theme.put(rule.translatedKey, theme.get(rule.rawKey));</span>
<span class="nc" id="L1679">                }</span>
            }

<span class="nc bnc" id="L1682" title="All 4 branches missed.">            if (fontScaleRules != null &amp;&amp; !fontKeys.isEmpty()) {</span>
<span class="nc" id="L1683">                float scale = 1f;</span>

<span class="nc bnc" id="L1685" title="All 2 branches missed.">                for (Map.Entry&lt;String, Float&gt; rule : fontScaleRules.entrySet()) {</span>
<span class="nc" id="L1686">                    String key = rule.getKey();</span>
<span class="nc" id="L1687">                    String skey = key.substring(1);</span>
<span class="nc bnc" id="L1688" title="All 2 branches missed.">                    if (skey.startsWith(&quot;device-&quot;)) {</span>
<span class="nc bnc" id="L1689" title="All 2 branches missed.">                        if (skey.startsWith(devicePrefix)) {</span>
<span class="nc" id="L1690">                            skey = skey.substring(devicePrefix.length());</span>
                        } else {
                            continue;
                        }
                    }
<span class="nc bnc" id="L1695" title="All 2 branches missed.">                    if (skey.startsWith(&quot;platform-&quot;)) {</span>
<span class="nc bnc" id="L1696" title="All 2 branches missed.">                        if (skey.startsWith(platformPrefix)) {</span>
<span class="nc" id="L1697">                            skey = skey.substring(platformPrefix.length());</span>
                        } else {
                            continue;
                        }

                    }

<span class="nc bnc" id="L1704" title="All 2 branches missed.">                    if (skey.startsWith(&quot;density-&quot;)) {</span>
<span class="nc bnc" id="L1705" title="All 2 branches missed.">                        if (skey.startsWith(densityPrefix)) {</span>
<span class="nc" id="L1706">                            skey = skey.substring(densityPrefix.length());</span>
                        } else {
                            continue;
                        }
                    }

<span class="nc bnc" id="L1712" title="All 2 branches missed.">                    if (&quot;font-scale&quot;.equals(skey)) {</span>
<span class="nc" id="L1713">                        scale *= rule.getValue();</span>
                    }


<span class="nc" id="L1717">                }</span>
<span class="nc bnc" id="L1718" title="All 2 branches missed.">                if (Math.abs(scale - 1f) &gt; 0.01) {</span>
<span class="nc bnc" id="L1719" title="All 2 branches missed.">                    for (String fontKey : fontKeys) {</span>
<span class="nc" id="L1720">                        Font f = (Font) theme.get(fontKey);</span>
<span class="nc bnc" id="L1721" title="All 4 branches missed.">                        if (f != null &amp;&amp; f.isTTFNativeFont()) {</span>
                            try {
<span class="nc" id="L1723">                                f = f.derive(f.getPixelSize() * scale, f.getStyle());</span>
<span class="nc" id="L1724">                                theme.put(fontKey, f);</span>
<span class="nc" id="L1725">                            } catch (Exception ex) {</span>
<span class="nc" id="L1726">                                Log.p(&quot;Failed to derive font &quot; + f + &quot; while loading font key &quot; + fontKey + &quot; from resource file. &quot; + ex.getMessage());</span>
<span class="nc" id="L1727">                                Log.e(ex);</span>
<span class="nc" id="L1728">                            }</span>
                        }

<span class="nc" id="L1731">                    }</span>
                }
            }
        }
<span class="nc" id="L1735">        return theme;</span>
    }

    private Object createBorder(DataInputStream input, int type) throws IOException {
<span class="nc bnc" id="L1739" title="All 17 branches missed.">        switch (type) {</span>
            // empty border
            case 0xff01:
<span class="nc" id="L1742">                return Border.getEmpty();</span>

            // Line border
            case 0xff02:
                // use theme colors?
<span class="nc bnc" id="L1747" title="All 2 branches missed.">                if (minorVersion &gt; 8) {</span>
<span class="nc bnc" id="L1748" title="All 2 branches missed.">                    if (input.readBoolean()) {</span>
<span class="nc bnc" id="L1749" title="All 2 branches missed.">                        if (input.readBoolean()) {</span>
<span class="nc" id="L1750">                            return Border.createLineBorder(input.readFloat());</span>
                        }
<span class="nc" id="L1752">                        return Border.createLineBorder((int) input.readFloat());</span>
                    } else {
<span class="nc bnc" id="L1754" title="All 2 branches missed.">                        if (input.readBoolean()) {</span>
<span class="nc" id="L1755">                            return Border.createLineBorder(input.readFloat(), input.readInt());</span>
                        }
<span class="nc" id="L1757">                        return Border.createLineBorder((int) input.readFloat(), input.readInt());</span>
                    }
                }
<span class="nc bnc" id="L1760" title="All 2 branches missed.">                if (input.readBoolean()) {</span>
<span class="nc" id="L1761">                    return Border.createLineBorder(input.readByte());</span>
                } else {
<span class="nc" id="L1763">                    return Border.createLineBorder(input.readByte(), input.readInt());</span>
                }

                // Underline border
            case 0xff14:
                // use theme colors?
<span class="nc bnc" id="L1769" title="All 2 branches missed.">                if (input.readBoolean()) {</span>
<span class="nc bnc" id="L1770" title="All 2 branches missed.">                    if (input.readBoolean()) {</span>
<span class="nc" id="L1771">                        return Border.createUndelineBorder(input.readFloat());</span>
                    }
<span class="nc" id="L1773">                    return Border.createUndelineBorder((int) input.readFloat());</span>
                } else {
<span class="nc bnc" id="L1775" title="All 2 branches missed.">                    if (input.readBoolean()) {</span>
<span class="nc" id="L1776">                        return Border.createUnderlineBorder(input.readFloat(), input.readInt());</span>
                    }
<span class="nc" id="L1778">                    return Border.createUnderlineBorder((int) input.readFloat(), input.readInt());</span>
                }

                // Rounded border
            case 0xff03:
                // use theme colors?
<span class="nc bnc" id="L1784" title="All 2 branches missed.">                if (input.readBoolean()) {</span>
<span class="nc" id="L1785">                    return Border.createRoundBorder(input.readByte(), input.readByte());</span>
                } else {
<span class="nc" id="L1787">                    return Border.createRoundBorder(input.readByte(), input.readByte(), input.readInt());</span>
                }

                // Etched Lowered border
            case 0xff04:
                // use theme colors?
<span class="nc bnc" id="L1793" title="All 2 branches missed.">                if (input.readBoolean()) {</span>
<span class="nc" id="L1794">                    return Border.createEtchedLowered();</span>
                } else {
<span class="nc" id="L1796">                    return Border.createEtchedLowered(input.readInt(), input.readInt());</span>
                }

                // Etched raised border
            case 0xff05:
                // use theme colors?
<span class="nc bnc" id="L1802" title="All 2 branches missed.">                if (input.readBoolean()) {</span>
<span class="nc" id="L1803">                    return Border.createEtchedRaised();</span>
                } else {
<span class="nc" id="L1805">                    return Border.createEtchedRaised(input.readInt(), input.readInt());</span>
                }

                // Bevel raised
            case 0xff07:
                // use theme colors?
<span class="nc bnc" id="L1811" title="All 2 branches missed.">                if (input.readBoolean()) {</span>
<span class="nc" id="L1812">                    return Border.createBevelRaised();</span>
                } else {
<span class="nc" id="L1814">                    return Border.createBevelRaised(input.readInt(), input.readInt(), input.readInt(), input.readInt());</span>
                }

                // Bevel lowered
            case 0xff06:
                // use theme colors?
<span class="nc bnc" id="L1820" title="All 2 branches missed.">                if (input.readBoolean()) {</span>
<span class="nc" id="L1821">                    return Border.createBevelLowered();</span>
                } else {
<span class="nc" id="L1823">                    return Border.createBevelLowered(input.readInt(), input.readInt(), input.readInt(), input.readInt());</span>
                }

                // Image border
            case 0xff08:
<span class="nc" id="L1828">                Object[] imageBorder = readImageBorder(input);</span>
<span class="nc" id="L1829">                return imageBorder;</span>

            // horizontal Image border
            case 0xff09:
<span class="nc" id="L1833">                return readImageBorder(input, &quot;h&quot;);</span>

            // vertical Image border
            case 0xff10:
<span class="nc" id="L1837">                return readImageBorder(input, &quot;v&quot;);</span>

            // scaled Image border
            case 0xff11:
<span class="nc" id="L1841">                return readScaledImageBorder(input);</span>

            // round border
            case 0xff12:
<span class="nc" id="L1845">                return RoundBorder.create().</span>
<span class="nc" id="L1846">                        rectangle(input.readBoolean()).</span>
<span class="nc" id="L1847">                        color(input.readInt()).</span>
<span class="nc" id="L1848">                        opacity(input.readInt()).</span>
<span class="nc" id="L1849">                        stroke(input.readFloat(), input.readBoolean()).</span>
<span class="nc" id="L1850">                        strokeColor(input.readInt()).</span>
<span class="nc" id="L1851">                        strokeOpacity(input.readInt()).</span>
<span class="nc" id="L1852">                        shadowBlur(input.readFloat()).</span>
<span class="nc" id="L1853">                        shadowOpacity(input.readInt()).</span>
<span class="nc" id="L1854">                        shadowSpread(input.readInt(), input.readBoolean()).</span>
<span class="nc" id="L1855">                        shadowX(input.readFloat()).</span>
<span class="nc" id="L1856">                        shadowY(input.readFloat());</span>

            // round rect border
            case 0xff13:
<span class="nc" id="L1860">                RoundRectBorder out = RoundRectBorder.create().</span>
<span class="nc" id="L1861">                        stroke(input.readFloat(), input.readBoolean()).</span>
<span class="nc" id="L1862">                        strokeColor(input.readInt()).</span>
<span class="nc" id="L1863">                        strokeOpacity(input.readInt()).</span>
<span class="nc" id="L1864">                        shadowBlur(input.readFloat()).</span>
<span class="nc" id="L1865">                        shadowOpacity(input.readInt()).</span>
<span class="nc" id="L1866">                        shadowSpread(input.readFloat()).</span>
<span class="nc" id="L1867">                        shadowX(input.readFloat()).</span>
<span class="nc" id="L1868">                        shadowY(input.readFloat()).</span>
<span class="nc" id="L1869">                        cornerRadius(input.readFloat()).</span>
<span class="nc" id="L1870">                        bezierCorners(input.readBoolean());</span>
<span class="nc bnc" id="L1871" title="All 2 branches missed.">                if (input.readBoolean()) {</span>
<span class="nc" id="L1872">                    out.topOnlyMode(true);</span>
                }
<span class="nc bnc" id="L1874" title="All 2 branches missed.">                if (input.readBoolean()) {</span>
<span class="nc" id="L1875">                    out.bottomOnlyMode(true);</span>
                }
<span class="nc" id="L1877">                return out;</span>

            //topOnlyMode(input.readBoolean()).
            //bottomOnlyMode(input.readBoolean());
            // round rect border with top-left, top-right, bottom-right, bottom-left corners
            // specified independently
            case 0xff15:
<span class="nc" id="L1884">                return RoundRectBorder.create().</span>
<span class="nc" id="L1885">                        stroke(input.readFloat(), input.readBoolean()).</span>
<span class="nc" id="L1886">                        strokeColor(input.readInt()).</span>
<span class="nc" id="L1887">                        strokeOpacity(input.readInt()).</span>
<span class="nc" id="L1888">                        shadowBlur(input.readFloat()).</span>
<span class="nc" id="L1889">                        shadowOpacity(input.readInt()).</span>
<span class="nc" id="L1890">                        shadowSpread(input.readFloat()).</span>
<span class="nc" id="L1891">                        shadowX(input.readFloat()).</span>
<span class="nc" id="L1892">                        shadowY(input.readFloat()).</span>
<span class="nc" id="L1893">                        cornerRadius(input.readFloat()).</span>
<span class="nc" id="L1894">                        bezierCorners(input.readBoolean()).</span>
<span class="nc" id="L1895">                        topLeftMode(input.readBoolean()).</span>
<span class="nc" id="L1896">                        topRightMode(input.readBoolean()).</span>
<span class="nc" id="L1897">                        bottomRightMode(input.readBoolean()).</span>
<span class="nc" id="L1898">                        bottomLeftMode(input.readBoolean());</span>

            case 0xff16:
                // CSS border
<span class="nc" id="L1902">                String cssStyles = input.readUTF();</span>
                try {
<span class="nc" id="L1904">                    return new CSSBorder(this, cssStyles);</span>
<span class="nc" id="L1905">                } catch (Throwable t) {</span>
<span class="nc" id="L1906">                    Log.p(&quot;Failed to load CSS border: &quot; + cssStyles);</span>
<span class="nc" id="L1907">                    Log.e(t);</span>
<span class="nc" id="L1908">                    return Border.createEmpty();</span>
                }

        }
<span class="nc" id="L1912">        return null;</span>
    }

    private String[] readImageBorder(DataInputStream input, String orientation) throws IOException {
<span class="nc" id="L1916">        String[] imageBorder = new String[4];</span>
<span class="nc" id="L1917">        imageBorder[0] = orientation;</span>
<span class="nc bnc" id="L1918" title="All 2 branches missed.">        for (int iter = 1; iter &lt; 4; iter++) {</span>
<span class="nc" id="L1919">            imageBorder[iter] = input.readUTF();</span>
        }
<span class="nc" id="L1921">        return imageBorder;</span>
    }

    private String[] readScaledImageBorder(DataInputStream input) throws IOException {
<span class="nc" id="L1925">        String[] a = readImageBorder(input);</span>
<span class="nc" id="L1926">        String[] b = new String[a.length + 1];</span>
<span class="nc" id="L1927">        System.arraycopy(a, 0, b, 1, a.length);</span>
<span class="nc" id="L1928">        b[0] = &quot;s&quot;;</span>
<span class="nc" id="L1929">        return b;</span>
    }

    private String[] readImageBorder(DataInputStream input) throws IOException {
        // Read number of images can be 2, 3, 8 or 9
<span class="nc" id="L1934">        int size = input.readByte();</span>
<span class="nc" id="L1935">        String[] imageBorder = new String[size];</span>

<span class="nc bnc" id="L1937" title="All 2 branches missed.">        for (int iter = 0; iter &lt; size; iter++) {</span>
<span class="nc" id="L1938">            imageBorder[iter] = input.readUTF();</span>
        }
<span class="nc" id="L1940">        return imageBorder;</span>
    }

    private Hashtable loadL10N() throws IOException {
<span class="fc" id="L1944">        Hashtable&lt;String, Hashtable&lt;String, String&gt;&gt; l10n = new Hashtable&lt;String, Hashtable&lt;String, String&gt;&gt;();</span>

<span class="fc" id="L1946">        int keys = input.readShort();</span>
<span class="fc" id="L1947">        int languages = input.readShort();</span>
<span class="fc" id="L1948">        String[] keyArray = new String[keys];</span>
<span class="fc bfc" id="L1949" title="All 2 branches covered.">        for (int iter = 0; iter &lt; keys; iter++) {</span>
<span class="fc" id="L1950">            String key = input.readUTF();</span>
<span class="fc" id="L1951">            keyArray[iter] = key;</span>
        }
<span class="fc bfc" id="L1953" title="All 2 branches covered.">        for (int iter = 0; iter &lt; languages; iter++) {</span>
<span class="fc" id="L1954">            Hashtable currentLanguage = new Hashtable();</span>
<span class="fc" id="L1955">            String lang = input.readUTF();</span>
<span class="fc" id="L1956">            l10n.put(lang, currentLanguage);</span>
<span class="fc bfc" id="L1957" title="All 2 branches covered.">            for (int valueIter = 0; valueIter &lt; keys; valueIter++) {</span>
<span class="fc" id="L1958">                currentLanguage.put(keyArray[valueIter], input.readUTF());</span>
            }
        }
<span class="fc" id="L1961">        return l10n;</span>
    }

    /**
     * Creates a packed image from the input stream for an 8 bit packed image
     */
    private Image createPackedImage8() throws IOException {
        // read the length of the palette;
<span class="nc" id="L1969">        int size = input.readByte() &amp; 0xff;</span>

        // 0 means the last bit overflowed, there is no sense for 0 sized palette
<span class="nc bnc" id="L1972" title="All 2 branches missed.">        if (size == 0) {</span>
<span class="nc" id="L1973">            size = 256;</span>
        }
<span class="nc" id="L1975">        int[] palette = new int[size];</span>
<span class="nc" id="L1976">        int plen = palette.length;</span>
<span class="nc bnc" id="L1977" title="All 2 branches missed.">        for (int iter = 0; iter &lt; plen; iter++) {</span>
<span class="nc" id="L1978">            palette[iter] = input.readInt();</span>
        }
<span class="nc" id="L1980">        int width = input.readShort();</span>
<span class="nc" id="L1981">        int height = input.readShort();</span>
<span class="nc" id="L1982">        byte[] data = new byte[width * height];</span>
<span class="nc" id="L1983">        input.readFully(data, 0, data.length);</span>
<span class="nc" id="L1984">        return Image.createIndexed(width, height, palette, data);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>