<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TextSelection.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">codenameone-core-unittests</a> &gt; <a href="index.source.html" class="el_package">com.codename1.ui</a> &gt; <span class="el_source">TextSelection.java</span></div><h1>TextSelection.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2012, Codename One and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Codename One designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Codename One through http://www.codenameone.com/ if you
 * need additional information or have any questions.
 */
package com.codename1.ui;

import com.codename1.ui.ComponentSelector.ComponentClosure;
import com.codename1.ui.events.ActionEvent;
import com.codename1.ui.events.ActionEvent.Type;
import com.codename1.ui.events.ActionListener;
import com.codename1.ui.geom.Dimension;
import com.codename1.ui.geom.Rectangle;
import com.codename1.ui.plaf.RoundRectBorder;
import com.codename1.ui.util.EventDispatcher;

import java.util.ArrayList;
import java.util.Comparator;
import java.util.Iterator;
import java.util.List;
import java.util.TreeSet;

import static com.codename1.ui.ComponentSelector.$;

/**
 * Text selection support for Codename One applications.  The class provides a light-weight text selection
 * implementation, allowing users to select and copy text from a form.
 *
 * &lt;h2&gt;Enabling Text Selection&lt;/h2&gt;
 *
 * &lt;p&gt;Text selection needs to be enabled on a per-form basis.&lt;/p&gt;
 * &lt;p&gt;
 * &lt;pre&gt;{@code
 * myForm.getTextSelection().setEnabled(true);
 * }&lt;/pre&gt;
 * &lt;/p&gt;
 *
 * &lt;p&gt;If text selection is enabled on a form, then non-editable text fields and text areas will allow text
 * selection by default.  Labels and SpanLabels have text selection disabled by default, but can be enabled using
 * {@link Label#setTextSelectionEnabled(boolean) }, and {@link SpanLabel#setTextSelectionEnabled(boolean)} respectively.
 * Similarly text selection can be disabled on TextFields and TextAreas using {@link TextArea#setTextSelectionEnabled(boolean) }.&lt;/p&gt;
 *
 * @author shannah
 * @since 7.0
 */
public class TextSelection {

    /**
     * Comparator used for ordering components in left-to-right mode.
     */
<span class="fc" id="L68">    private static final Comparator&lt;Component&gt; LTRComparator = new Comparator&lt;Component&gt;() {</span>

        /**
         * We can't just use component's AbsoluteY coordinates for ordering because of scrolling,
         * so we create a scaled coorindate that will order components properly.
         * @param cmp
         * @return
         */
        private double getScaledY(Component cmp) {
<span class="fc" id="L77">            double y = 0;</span>
<span class="fc bfc" id="L78" title="All 2 branches covered.">            while (cmp != null) {</span>
<span class="fc" id="L79">                double ratio = cmp.getHeight() / (double) Math.max(cmp.getScrollDimension().getHeight(), cmp.getHeight());</span>
<span class="fc" id="L80">                y = ratio * y;</span>
<span class="fc" id="L81">                y += cmp.getY() + cmp.getScrollY();</span>
<span class="fc" id="L82">                cmp = cmp.getParent();</span>
<span class="fc" id="L83">            }</span>
<span class="fc" id="L84">            return y;</span>
        }

        @Override
        public int compare(Component o1, Component o2) {
<span class="fc" id="L89">            int x1 = o1.getAbsoluteX();</span>
<span class="fc" id="L90">            int x2 = o2.getAbsoluteX();</span>
<span class="fc" id="L91">            double y1 = getScaledY(o1);</span>
<span class="fc" id="L92">            double y2 = getScaledY(o2);</span>

            int compareY;
<span class="pc bpc" id="L95" title="1 of 2 branches missed.">            if (y1 &lt; y2) {</span>
<span class="nc" id="L96">                compareY = -1;</span>
<span class="pc bpc" id="L97" title="1 of 2 branches missed.">            } else if (y1 &gt; y2) {</span>
<span class="nc" id="L98">                compareY = 1;</span>
            } else {
<span class="fc" id="L100">                compareY = 0;</span>
            }
<span class="pc bpc" id="L102" title="1 of 2 branches missed.">            if (compareY != 0) {</span>
<span class="nc" id="L103">                return compareY;</span>
            }
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">            if (x1 &lt; x2) {</span>
<span class="nc" id="L106">                return -1;</span>
<span class="pc bpc" id="L107" title="1 of 2 branches missed.">            } else if (x1 &gt; x2) {</span>
<span class="nc" id="L108">                return 1;</span>
            }
<span class="fc" id="L110">            int w1 = o1.getWidth();</span>
<span class="fc" id="L111">            int w2 = o2.getWidth();</span>
<span class="fc" id="L112">            int h1 = o1.getHeight();</span>
<span class="fc" id="L113">            int h2 = o2.getHeight();</span>

<span class="pc bpc" id="L115" title="1 of 2 branches missed.">            if (h1 != h2) {</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">                return h1 &gt; h2 ? -1 : 1;</span>
            }
<span class="pc bpc" id="L118" title="1 of 2 branches missed.">            if (w1 != w2) {</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">                return w1 &gt; w2 ? -1 : 1;</span>
            }
<span class="fc" id="L121">            return 0;</span>
        }

    };
    /**
     * Comparator used for ordering components in left-to-right mode.
     */
<span class="fc" id="L128">    private static final Comparator&lt;Component&gt; RTLComparator = new Comparator&lt;Component&gt;() {</span>
        /**
         * We can't just use component's AbsoluteY coordinates for ordering because of scrolling,
         * so we create a scaled coorindate that will order components properly.
         * @param cmp
         * @return
         */
        private double getScaledY(Component cmp) {
<span class="nc" id="L136">            double y = 0;</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">            while (cmp != null) {</span>
<span class="nc" id="L138">                double ratio = cmp.getHeight() / (double) Math.max(cmp.getScrollDimension().getHeight(), cmp.getHeight());</span>
<span class="nc" id="L139">                y = ratio * y;</span>
<span class="nc" id="L140">                y += cmp.getY() + cmp.getScrollY();</span>
<span class="nc" id="L141">                cmp = cmp.getParent();</span>
<span class="nc" id="L142">            }</span>
<span class="nc" id="L143">            return y;</span>
        }

        @Override
        public int compare(Component o1, Component o2) {
<span class="nc" id="L148">            int x1 = o1.getAbsoluteX();</span>
<span class="nc" id="L149">            int x2 = o2.getAbsoluteX();</span>
<span class="nc" id="L150">            double y1 = getScaledY(o1);</span>
<span class="nc" id="L151">            double y2 = getScaledY(o2);</span>

            int compareY;
<span class="nc bnc" id="L154" title="All 2 branches missed.">            if (y1 &lt; y2) {</span>
<span class="nc" id="L155">                compareY = -1;</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">            } else if (y1 &gt; y2) {</span>
<span class="nc" id="L157">                compareY = 1;</span>
            } else {
<span class="nc" id="L159">                compareY = 0;</span>
            }
<span class="nc bnc" id="L161" title="All 2 branches missed.">            if (compareY != 0) {</span>
<span class="nc" id="L162">                return compareY;</span>
            }
<span class="nc bnc" id="L164" title="All 2 branches missed.">            if (x1 &lt; x2) {</span>
<span class="nc" id="L165">                return 1;</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">            } else if (x1 &gt; x2) {</span>
<span class="nc" id="L167">                return -1;</span>
            }
<span class="nc" id="L169">            int w1 = o1.getWidth();</span>
<span class="nc" id="L170">            int w2 = o2.getWidth();</span>
<span class="nc" id="L171">            int h1 = o1.getHeight();</span>
<span class="nc" id="L172">            int h2 = o2.getHeight();</span>

<span class="nc bnc" id="L174" title="All 2 branches missed.">            if (h1 != h2) {</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">                return h1 &gt; h2 ? -1 : 1;</span>
            }
<span class="nc bnc" id="L177" title="All 2 branches missed.">            if (w1 != w2) {</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">                return w1 &gt; w2 ? -1 : 1;</span>
            }
<span class="nc" id="L180">            return 0;</span>
        }

    };
<span class="fc" id="L184">    private final Rectangle snappedSelectedBounds = new Rectangle();</span>
<span class="fc" id="L185">    private final Rectangle selectedBounds = new Rectangle();</span>
<span class="fc" id="L186">    private final Spans selectedSpans = new Spans();</span>
<span class="fc" id="L187">    private final EventDispatcher textSelectionListeners = new EventDispatcher();</span>
<span class="fc" id="L188">    private final Rectangle tmpRect = new Rectangle();</span>
    private SelectionMask selectionMask;
    private final Component root;
<span class="fc" id="L191">    private final boolean ltr = true;</span>
    private boolean enabled;
<span class="fc" id="L193">    private final TextSelectionTrigger trigger = getDefaultTextSelectionTrigger();</span>
    // The nearest scrollable parent of the component that triggered a text
    // selection event.
    private Component selectionRoot;
    private boolean ignoreEvents;
    /**
     * The listener that handles all of the pointer events to update the selections.
     */
<span class="fc" id="L201">    private final ActionListener pressListener = new ActionListener() {</span>
        int startX, startY;
        int startDragHandleX, startDragHandleY;
<span class="fc" id="L204">        final Rectangle startSelectedBounds = new Rectangle();</span>
        boolean inSelectionDrag;
<span class="fc" id="L206">        private final int ONE_MM = CN.convertToPixels(1);</span>

        @Override
        public void actionPerformed(final ActionEvent evt) {
<span class="nc bnc" id="L210" title="All 4 branches missed.">            if (ignoreEvents || Display.getInstance().isRightMouseButtonDown()) {</span>
<span class="nc" id="L211">                return;</span>
            }
<span class="nc bnc" id="L213" title="All 2 branches missed.">            if (trigger == TextSelectionTrigger.Press) {</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">                if (evt.getEventType() == ActionEvent.Type.PointerPressed) {</span>
<span class="nc" id="L215">                    selectedBounds.setBounds(-1, -1, 0, 0);</span>
<span class="nc" id="L216">                    update();</span>
<span class="nc" id="L217">                    textSelectionListeners.fireActionEvent(new ActionEvent(TextSelection.this, Type.Change));</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">                    if (selectionMask != null) {</span>
<span class="nc" id="L219">                        selectionMask.remove();</span>
<span class="nc" id="L220">                        getLayeredPane().remove();</span>
<span class="nc" id="L221">                        selectionMask = null;</span>
<span class="nc" id="L222">                        root.getComponentForm().revalidate();</span>
                    }
<span class="nc" id="L224">                    startX = evt.getX();</span>
<span class="nc" id="L225">                    startY = evt.getY();</span>
<span class="nc" id="L226">                    inSelectionDrag = false;</span>
<span class="nc" id="L227">                    Component cmp = ((Container) root).getComponentAt(startX, startY);</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">                    if (cmp == null) {</span>
<span class="nc" id="L229">                        return;</span>
                    }
<span class="nc" id="L231">                    selectionRoot = findSelectionRoot(cmp);</span>
                    //System.out.println(&quot;SelectionRoot =&quot;+selectionRoot);
<span class="nc" id="L233">                    startX = startX - selectionRoot.getAbsoluteX();</span>
<span class="nc" id="L234">                    startY = startY - selectionRoot.getAbsoluteY();</span>
<span class="nc" id="L235">                    TextSelectionSupport ts = cmp.getTextSelectionSupport();</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">                    if (ts != null) {</span>
<span class="nc bnc" id="L237" title="All 4 branches missed.">                        if (ts.isTextSelectionEnabled(TextSelection.this) &amp;&amp; ts.isTextSelectionTriggerEnabled(TextSelection.this)) {</span>
<span class="nc" id="L238">                            evt.consume();</span>
<span class="nc" id="L239">                            inSelectionDrag = true;</span>
                        }
                    }
<span class="nc bnc" id="L242" title="All 2 branches missed.">                } else if (evt.getEventType() == ActionEvent.Type.PointerDrag) {</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">                    if (!inSelectionDrag) {</span>
<span class="nc" id="L244">                        return;</span>
                    }
<span class="nc" id="L246">                    evt.consume();</span>


<span class="nc" id="L249">                    int x = evt.getX() - selectionRoot.getAbsoluteX();</span>
<span class="nc" id="L250">                    int y = evt.getY() - selectionRoot.getAbsoluteY();</span>
<span class="nc" id="L251">                    selectedBounds.setBounds(</span>
<span class="nc" id="L252">                            Math.min(startX, x),</span>
<span class="nc" id="L253">                            Math.min(startY, y),</span>
<span class="nc" id="L254">                            Math.abs(startX - x),</span>
<span class="nc" id="L255">                            Math.abs(startY - y)</span>
                    );
<span class="nc" id="L257">                    update();</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">                    if (selectionMask == null) {</span>
<span class="nc" id="L259">                        selectionMask = new SelectionMask();</span>

<span class="nc" id="L261">                        getLayeredPane().add(selectionMask);</span>

                    }
<span class="nc" id="L264">                    root.getComponentForm().revalidate();</span>
<span class="nc bnc" id="L265" title="All 4 branches missed.">                    if (selectionRoot.isScrollableX() &amp;&amp; evt.getX() &gt; selectionRoot.getAbsoluteX() + selectionRoot.getScrollX() + selectionRoot.getWidth() - ONE_MM * 5) {</span>
<span class="nc" id="L266">                        Component.setDisableSmoothScrolling(true);</span>
<span class="nc" id="L267">                        int scrollX = selectionRoot.getScrollX();</span>
<span class="nc" id="L268">                        selectionRoot.setScrollX(selectionRoot.getScrollX() + ONE_MM);</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">                        if (scrollX != selectionRoot.getScrollX()) {</span>
<span class="nc" id="L270">                            selectionRoot.repaint();</span>
<span class="nc" id="L271">                            CN.callSerially(new Runnable() {</span>
                                public void run() {
<span class="nc" id="L273">                                    Form f = selectionRoot.getComponentForm();</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">                                    if (f != null) {</span>
<span class="nc" id="L275">                                        f.pointerDragged(evt.getX(), evt.getY());</span>
                                    }
<span class="nc" id="L277">                                }</span>
                            });
                        }
<span class="nc" id="L280">                        Component.setDisableSmoothScrolling(false);</span>
<span class="nc bnc" id="L281" title="All 4 branches missed.">                    } else if (selectionRoot.isScrollableX() &amp;&amp; evt.getX() &lt; selectionRoot.getAbsoluteX() + selectionRoot.getScrollX() + ONE_MM * 5) {</span>
<span class="nc" id="L282">                        Component.setDisableSmoothScrolling(true);</span>
<span class="nc" id="L283">                        int scrollX = selectionRoot.getScrollX();</span>
<span class="nc" id="L284">                        selectionRoot.setScrollX(selectionRoot.getScrollX() - ONE_MM);</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">                        if (scrollX != selectionRoot.getScrollX()) {</span>
<span class="nc" id="L286">                            selectionRoot.repaint();</span>
<span class="nc" id="L287">                            CN.callSerially(new Runnable() {</span>
                                public void run() {
<span class="nc" id="L289">                                    Form f = selectionRoot.getComponentForm();</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">                                    if (f != null) {</span>
<span class="nc" id="L291">                                        f.pointerDragged(evt.getX(), evt.getY());</span>
                                    }
<span class="nc" id="L293">                                }</span>
                            });
                        }
<span class="nc" id="L296">                        Component.setDisableSmoothScrolling(false);</span>
<span class="nc bnc" id="L297" title="All 4 branches missed.">                    } else if (selectionRoot.isScrollableY() &amp;&amp; evt.getY() &lt; selectionRoot.getAbsoluteY() + selectionRoot.getScrollY() + ONE_MM * 5) {</span>
<span class="nc" id="L298">                        Component.setDisableSmoothScrolling(true);</span>
<span class="nc" id="L299">                        int scrollY = selectionRoot.getScrollY();</span>
<span class="nc" id="L300">                        selectionRoot.setScrollY(selectionRoot.getScrollY() - ONE_MM);</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">                        if (scrollY != selectionRoot.getScrollY()) {</span>
<span class="nc" id="L302">                            selectionRoot.repaint();</span>
<span class="nc" id="L303">                            CN.callSerially(new Runnable() {</span>
                                public void run() {
<span class="nc" id="L305">                                    Form f = selectionRoot.getComponentForm();</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">                                    if (f != null) {</span>
<span class="nc" id="L307">                                        f.pointerDragged(evt.getX(), evt.getY());</span>
                                    }
<span class="nc" id="L309">                                }</span>
                            });
                        }
<span class="nc" id="L312">                        Component.setDisableSmoothScrolling(false);</span>
<span class="nc bnc" id="L313" title="All 4 branches missed.">                    } else if (selectionRoot.isScrollableY() &amp;&amp; evt.getY() &gt; selectionRoot.getAbsoluteY() + selectionRoot.getScrollY() + selectionRoot.getHeight() - ONE_MM * 5) {</span>
<span class="nc" id="L314">                        Component.setDisableSmoothScrolling(true);</span>
<span class="nc" id="L315">                        int scrollY = selectionRoot.getScrollY();</span>
<span class="nc" id="L316">                        selectionRoot.setScrollY(selectionRoot.getScrollY() + ONE_MM);</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">                        if (scrollY != selectionRoot.getScrollY()) {</span>
<span class="nc" id="L318">                            selectionRoot.repaint();</span>
<span class="nc" id="L319">                            CN.callSerially(new Runnable() {</span>
                                public void run() {
<span class="nc" id="L321">                                    Form f = selectionRoot.getComponentForm();</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">                                    if (f != null) {</span>
<span class="nc" id="L323">                                        f.pointerDragged(evt.getX(), evt.getY());</span>
                                    }
<span class="nc" id="L325">                                }</span>
                            });
                        }
<span class="nc" id="L328">                        Component.setDisableSmoothScrolling(false);</span>
                    }
<span class="nc bnc" id="L330" title="All 4 branches missed.">                } else if (evt.getEventType() == ActionEvent.Type.PointerReleased || evt.getEventType() == ActionEvent.Type.DragFinished) {</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">                    if (inSelectionDrag) {</span>
<span class="nc" id="L332">                        textSelectionListeners.fireActionEvent(new ActionEvent(TextSelection.this, Type.Change));</span>
<span class="nc" id="L333">                        evt.consume();</span>
                    }
                }
            } else {
                // Long press trigger
<span class="nc bnc" id="L338" title="All 2 branches missed.">                if (evt.getSource() instanceof DragHandle) {</span>
<span class="nc" id="L339">                    DragHandle dh = (DragHandle) evt.getSource();</span>

<span class="nc bnc" id="L341" title="All 2 branches missed.">                    if (evt.getEventType() == ActionEvent.Type.PointerPressed) {</span>
<span class="nc" id="L342">                        startX = evt.getX();</span>
<span class="nc" id="L343">                        startY = evt.getY();</span>
<span class="nc" id="L344">                        startDragHandleX = dh.getAbsoluteX();</span>
<span class="nc" id="L345">                        startDragHandleY = dh.getAbsoluteY();</span>
<span class="nc" id="L346">                        startSelectedBounds.setBounds(selectedBounds);</span>
<span class="nc" id="L347">                        inSelectionDrag = true;</span>
<span class="nc" id="L348">                        evt.consume();</span>
<span class="nc" id="L349">                        dh.pointerDragged(evt.getX(), evt.getY());</span>

<span class="nc bnc" id="L351" title="All 4 branches missed.">                    } else if (inSelectionDrag &amp;&amp; evt.getEventType() == ActionEvent.Type.PointerDrag) {</span>
<span class="nc" id="L352">                        evt.consume();</span>
<span class="nc" id="L353">                        int offX = evt.getX() - startX;</span>
<span class="nc" id="L354">                        int offY = evt.getY() - startY;</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">                        if (dh.start) {</span>
<span class="nc" id="L356">                            selectedBounds.setX(startSelectedBounds.getX() + offX);</span>
<span class="nc" id="L357">                            selectedBounds.setWidth(startSelectedBounds.getWidth() - offX);</span>
<span class="nc" id="L358">                            selectedBounds.setY(startSelectedBounds.getY() + offY);</span>
<span class="nc" id="L359">                            selectedBounds.setHeight(startSelectedBounds.getHeight() - offY);</span>
                        } else {
<span class="nc" id="L361">                            selectedBounds.setWidth(startSelectedBounds.getWidth() + offX);</span>
<span class="nc" id="L362">                            selectedBounds.setHeight(startSelectedBounds.getHeight() + offY);</span>
                        }
<span class="nc" id="L364">                        update();</span>
<span class="nc" id="L365">                        root.getComponentForm().revalidate();</span>
<span class="nc bnc" id="L366" title="All 6 branches missed.">                    } else if (inSelectionDrag &amp;&amp; evt.getEventType() == ActionEvent.Type.PointerReleased || evt.getEventType() == ActionEvent.Type.DragFinished) {</span>
<span class="nc" id="L367">                        evt.consume();</span>
<span class="nc" id="L368">                        inSelectionDrag = false;</span>
<span class="nc" id="L369">                        update();</span>
<span class="nc" id="L370">                        root.getComponentForm().revalidate();</span>
<span class="nc" id="L371">                        textSelectionListeners.fireActionEvent(new ActionEvent(TextSelection.this, Type.Change));</span>
                    }
<span class="nc" id="L373">                } else {</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">                    if (evt.getEventType() == ActionEvent.Type.LongPointerPress) {</span>
                        //System.out.println(&quot;In long press&quot;);
<span class="nc" id="L376">                        Component cmp = ((Container) root).getComponentAt(evt.getX(), evt.getY());</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">                        if (cmp == null) {</span>
<span class="nc" id="L378">                            return;</span>
                        }
<span class="nc" id="L380">                        TextSelectionSupport st = cmp.getTextSelectionSupport();</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">                        if (st != null) {</span>

<span class="nc bnc" id="L383" title="All 4 branches missed.">                            if (!st.isTextSelectionEnabled(TextSelection.this) || !st.isTextSelectionTriggerEnabled(TextSelection.this)) {</span>
<span class="nc" id="L384">                                return;</span>
                            }
<span class="nc" id="L386">                            selectionRoot = findSelectionRoot(cmp);</span>
<span class="nc" id="L387">                            int x = evt.getX() - selectionRoot.getAbsoluteX();</span>

<span class="nc" id="L389">                            int y = evt.getY() - selectionRoot.getAbsoluteY();</span>
<span class="nc" id="L390">                            Span selSpan = st.triggerSelectionAt(TextSelection.this, x, y);</span>
                            //System.out.println(selSpan);
<span class="nc bnc" id="L392" title="All 2 branches missed.">                            if (selSpan == null) {</span>
<span class="nc" id="L393">                                return;</span>
                            }
<span class="nc" id="L395">                            evt.consume();</span>
<span class="nc" id="L396">                            Rectangle sel = selSpan.getBounds();</span>
<span class="nc" id="L397">                            selectedBounds.setBounds(sel.getX(), sel.getY(), sel.getWidth(), sel.getHeight());</span>
<span class="nc" id="L398">                            update();</span>
<span class="nc" id="L399">                            textSelectionListeners.fireActionEvent(new ActionEvent(TextSelection.this, Type.Change));</span>
<span class="nc bnc" id="L400" title="All 2 branches missed.">                            if (selectionMask == null) {</span>
<span class="nc" id="L401">                                selectionMask = new SelectionMask();</span>
<span class="nc" id="L402">                                Container layeredPane = getLayeredPane();</span>
<span class="nc" id="L403">                                layeredPane.add(selectionMask);</span>

                            }
<span class="nc" id="L406">                            root.getComponentForm().revalidate();</span>


                        }
<span class="nc bnc" id="L410" title="All 2 branches missed.">                    } else if (evt.getEventType() == ActionEvent.Type.PointerPressed) {</span>
<span class="nc" id="L411">                        Component cmp = ((Container) root).getComponentAt(evt.getX(), evt.getY());</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">                        if (cmp instanceof DragHandle) {</span>
<span class="nc" id="L413">                            return;</span>
                        }
<span class="nc bnc" id="L415" title="All 2 branches missed.">                        if (selectionMask != null) {</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">                            if (selectionMask.startHandle.contains(evt.getX(), evt.getY())) {</span>
<span class="nc" id="L417">                                return;</span>
                            }
<span class="nc bnc" id="L419" title="All 2 branches missed.">                            if (selectionMask.endHandle.contains(evt.getX(), evt.getY())) {</span>
<span class="nc" id="L420">                                return;</span>
                            }
<span class="nc bnc" id="L422" title="All 2 branches missed.">                            if (selectionMask.selectionMenu.contains(evt.getX(), evt.getY())) {</span>
<span class="nc" id="L423">                                return;</span>
                            }
                        }
<span class="nc" id="L426">                        selectedBounds.setBounds(-1, -1, 0, 0);</span>
<span class="nc" id="L427">                        update();</span>
<span class="nc" id="L428">                        textSelectionListeners.fireActionEvent(new ActionEvent(TextSelection.this, Type.Change));</span>
<span class="nc bnc" id="L429" title="All 2 branches missed.">                        if (selectionMask != null) {</span>
<span class="nc" id="L430">                            selectionMask.remove();</span>
<span class="nc" id="L431">                            getLayeredPane().remove();</span>
<span class="nc" id="L432">                            selectionMask = null;</span>
<span class="nc" id="L433">                            root.getComponentForm().revalidate();</span>
                        }
                    }
                }
            }
<span class="nc" id="L438">        }</span>

    };

    /**
     * Creates a new TextSelection handler with the given root component.  Package private.  Use {@link Form#getTextSelection() } to obtain
     * an instance of the Form's TextSelection.
     *
     * @param root
     */
<span class="fc" id="L448">    TextSelection(Component root) {</span>
<span class="fc" id="L449">        this.root = root;</span>
<span class="fc" id="L450">    }</span>

    /**
     * Gets the default trigger type for text selection.  This will vary by platform.
     * On mobile/touch devices, it will return {@link TextSelectionTrigger#LongPress},
     * and on desktop environments with a mouse, it will return {@link TextSelectionTrigger#Press}.
     *
     * @return The default trigger type for text selection.
     */
    public static TextSelectionTrigger getDefaultTextSelectionTrigger() {
<span class="pc bpc" id="L460" title="1 of 2 branches missed.">        return Display.impl.isDesktop() ? TextSelectionTrigger.Press : TextSelectionTrigger.LongPress;</span>
    }

    private static int getX(Component cmp, Component relativeTo) {
<span class="fc" id="L464">        return cmp.getAbsoluteX() - relativeTo.getAbsoluteX();</span>
    }

    private static int getY(Component cmp, Component relativeTo) {
<span class="fc" id="L468">        return cmp.getAbsoluteY() - relativeTo.getAbsoluteY();</span>
    }

    /**
     * Finds the selection root for a component.  This is generally just the first
     * scrollable component discovered with crawling up the component hierarchy
     * from the given component.
     *
     * @param cmp The component we start with.
     * @return The selection root for a given component.
     */
    public static Component findSelectionRoot(Component cmp) {
<span class="pc bpc" id="L480" title="1 of 4 branches missed.">        if (cmp.scrollableYFlag() || cmp.scrollableXFlag()) {</span>
<span class="fc" id="L481">            return cmp;</span>
        }
<span class="fc" id="L483">        Container parent = cmp.getParent();</span>
<span class="pc bpc" id="L484" title="1 of 2 branches missed.">        if (parent == null) {</span>
<span class="nc" id="L485">            return cmp;</span>
        }
<span class="fc" id="L487">        return findSelectionRoot(parent);</span>
    }

    /**
     * Returns true if text selection is enabled.  Default is false.
     *
     * @return
     */
    public boolean isEnabled() {
<span class="fc" id="L496">        return enabled;</span>
    }

    /**
     * Enables or disables text selection.
     *
     * @param enabled
     */
    public void setEnabled(boolean enabled) {
<span class="pc bpc" id="L505" title="1 of 2 branches missed.">        if (enabled != this.enabled) {</span>
<span class="fc" id="L506">            this.enabled = enabled;</span>
<span class="fc" id="L507">            Component f = root.getComponentForm();</span>
<span class="fc bfc" id="L508" title="All 2 branches covered.">            if (enabled) {</span>
<span class="fc" id="L509">                Form form = f.getComponentForm();</span>
<span class="fc" id="L510">                form.setEnableCursors(true);</span>
<span class="fc" id="L511">                f.addPointerPressedListener(pressListener);</span>
<span class="fc" id="L512">                f.addPointerDraggedListener(pressListener);</span>
<span class="fc" id="L513">                f.addPointerReleasedListener(pressListener);</span>
<span class="fc" id="L514">                f.addDragFinishedListener(pressListener);</span>
<span class="fc" id="L515">                f.addLongPressListener(pressListener);</span>
<span class="fc" id="L516">                Display.impl.initializeTextSelection(this);</span>
<span class="fc" id="L517">            } else {</span>
<span class="fc" id="L518">                f.removePointerPressedListener(pressListener);</span>
<span class="fc" id="L519">                f.removePointerDraggedListener(pressListener);</span>
<span class="fc" id="L520">                f.removePointerReleasedListener(pressListener);</span>
<span class="fc" id="L521">                f.removeDragFinishedListener(pressListener);</span>
<span class="fc" id="L522">                f.addLongPressListener(pressListener);</span>
<span class="fc" id="L523">                Display.impl.deinitializeTextSelection(this);</span>
            }
        }
<span class="fc" id="L526">    }</span>

    /**
     * Gets the selection root for the current text selection.  The selection root will be
     * the nearest scrollable parent of the component that triggered the text selection.
     *
     * &lt;p&gt;Note:  All Span coordinates are relative to the selection root&lt;/p&gt;
     *
     * @return
     */
    public Component getSelectionRoot() {
<span class="fc bfc" id="L537" title="All 2 branches covered.">        if (selectionRoot == null) {</span>
<span class="fc" id="L538">            selectionRoot = root;</span>
        }
<span class="fc" id="L540">        return selectionRoot;</span>
    }

    /**
     * Creates a new Char box.
     *
     * @param pos The position of the character that this is referencing within its text component.
     * @param x   The x coordinate of the box, relative to {@link #getSelectionRoot() }
     * @param y   The y coordinate of the box, relative to {@link #getSelectionRoot() }
     * @param w   The width of the box.
     * @param h   The height of the box.
     * @return
     */
    public Char newChar(int pos, int x, int y, int w, int h) {
<span class="fc" id="L554">        return new Char(pos, x, y, w, h);</span>
    }

    /**
     * Creates a new Char box
     *
     * @param pos    The position of the character that this is referencing within its text component.
     * @param bounds The bounds of the box, relative to {@link #getSelectionRoot() }
     * @return
     */
    public Char newChar(int pos, Rectangle bounds) {
<span class="nc" id="L565">        return newChar(pos, bounds);</span>
    }

    /**
     * Creates a new Span based on content in the given component.
     *
     * @param component
     * @return A new span
     */
    public Span newSpan(Component component) {
<span class="fc" id="L575">        return new Span(component);</span>
    }

    /**
     * Creates a new Spans (a collection of Spans).
     *
     * @return
     */
    public Spans newSpans() {
<span class="fc" id="L584">        return new Spans();</span>
    }

    /**
     * Gets the selected text as a string.
     *
     * @return
     */
    public String getSelectionAsText() {
<span class="fc" id="L593">        return selectedSpans.getText();</span>
    }

    /**
     * Updates the text selected spans based on the selected bounds.
     */
    public void update() {
<span class="pc bpc" id="L600" title="1 of 2 branches missed.">        if (selectionRoot == null) {</span>
<span class="nc" id="L601">            selectionRoot = root;</span>

        }
<span class="fc" id="L604">        final TreeSet&lt;Component&gt; selectedComponents = new TreeSet&lt;Component&gt;(ltr ? LTRComparator : RTLComparator);</span>
<span class="fc" id="L605">        $(&quot;*&quot;, selectionRoot).each(new ComponentClosure() {</span>
            @Override
            public void call(Component c) {
<span class="fc" id="L608">                TextSelectionSupport ts = c.getTextSelectionSupport();</span>
<span class="pc bpc" id="L609" title="1 of 4 branches missed.">                if (ts != null &amp;&amp; ts.isTextSelectionEnabled(TextSelection.this)) {</span>
<span class="fc" id="L610">                    selectedComponents.add(c);</span>
                }
<span class="fc" id="L612">            }</span>

        });


<span class="fc" id="L617">        Spans spans = selectedSpans;</span>
<span class="fc" id="L618">        spans.clear();</span>
<span class="fc" id="L619">        tmpRect.setBounds(selectedBounds);</span>
<span class="fc bfc" id="L620" title="All 2 branches covered.">        for (Component cmp : selectedComponents) {</span>
<span class="fc" id="L621">            TextSelectionSupport st = cmp.getTextSelectionSupport();</span>
<span class="pc bpc" id="L622" title="1 of 2 branches missed.">            if (st == null) {</span>
<span class="nc" id="L623">                continue;</span>
            }
<span class="pc bpc" id="L625" title="1 of 2 branches missed.">            if (isVerticallyCoveredByBounds(cmp, selectedBounds)) {</span>
                // When selecting scrollable components, we need to adjust the bounds
                // so that we get the entire contents - not just the visible viewport
<span class="fc" id="L628">                selectedBounds.setX(getX(cmp, selectionRoot));</span>
<span class="fc" id="L629">                selectedBounds.setY(getY(cmp, selectionRoot));</span>
<span class="fc" id="L630">                selectedBounds.setWidth(Math.max(cmp.getScrollDimension().getWidth(), cmp.getWidth()));</span>
<span class="fc" id="L631">                selectedBounds.setHeight(Math.max(cmp.getScrollDimension().getHeight(), cmp.getHeight()));</span>

            }
<span class="fc" id="L634">            spans.add(st.getTextSelectionForBounds(this, selectedBounds));</span>
            // In case selectedBounds was changed we reset
<span class="fc" id="L636">            selectedBounds.setBounds(tmpRect);</span>
<span class="fc" id="L637">        }</span>

<span class="fc" id="L639">    }</span>

    private boolean isVerticallyCoveredByBounds(Component cmp, Rectangle bounds) {
<span class="fc" id="L642">        int cmpX = getX(cmp, selectionRoot) + cmp.getScrollX();</span>
<span class="fc" id="L643">        int cmpY = getY(cmp, selectionRoot) + cmp.getScrollY();</span>
<span class="pc bpc" id="L644" title="2 of 4 branches missed.">        boolean isVerticallyCovered = cmpY &gt;= bounds.getY() &amp;&amp; cmpY + cmp.getHeight() &lt;= bounds.getY() + bounds.getHeight();</span>
<span class="pc bpc" id="L645" title="1 of 2 branches missed.">        if (isVerticallyCovered) {</span>
<span class="fc" id="L646">            return true;</span>
        }
<span class="nc bnc" id="L648" title="All 2 branches missed.">        if (cmp == selectionRoot) {</span>
<span class="nc" id="L649">            return false;</span>
        }
<span class="nc" id="L651">        Container parent = cmp.getParent();</span>
<span class="nc bnc" id="L652" title="All 2 branches missed.">        if (parent != null) {</span>
<span class="nc" id="L653">            return isVerticallyCoveredByBounds(parent, bounds);</span>
        }
<span class="nc" id="L655">        return false;</span>
    }

    private boolean shouldCoverToEndOfLine(Span span, Rectangle bounds) {
<span class="nc" id="L659">        int spy = span.getBounds().getY();</span>
<span class="nc" id="L660">        int sph = span.getBounds().getHeight();</span>
<span class="nc bnc" id="L661" title="All 4 branches missed.">        return spy + 2 * sph / 3 &gt; bounds.getY() &amp;&amp; spy + sph &lt;= bounds.getY() + bounds.getHeight();</span>
    }

    private void updateSnappedSelectedBounds() {
<span class="fc" id="L665">        snappedSelectedBounds.setBounds(selectedBounds.getX(), selectedBounds.getY(), selectedBounds.getWidth(), selectedBounds.getHeight());</span>
<span class="fc bfc" id="L666" title="All 2 branches covered.">        for (Span span : selectedSpans) {</span>
<span class="fc" id="L667">            int x = Math.min(span.getBounds().getX(), snappedSelectedBounds.getX());</span>
<span class="fc" id="L668">            int y = Math.min(span.getBounds().getY(), snappedSelectedBounds.getY());</span>
<span class="fc" id="L669">            int w = Math.max(span.getBounds().getX() + span.getBounds().getWidth(), selectedBounds.getX() + selectedBounds.getWidth()) - x;</span>
<span class="fc" id="L670">            int h = Math.max(span.getBounds().getY() + span.getBounds().getHeight(), selectedBounds.getY() + selectedBounds.getHeight()) - y;</span>
<span class="fc" id="L671">            snappedSelectedBounds.setBounds(x, y, w, h);</span>
<span class="fc" id="L672">        }</span>
<span class="fc" id="L673">    }</span>

    /**
     * Adds a listener to be notified when the text selection changes.
     *
     * @param l
     */
    public void addTextSelectionListener(ActionListener l) {
<span class="fc" id="L681">        textSelectionListeners.addListener(l);</span>
<span class="fc" id="L682">    }</span>

    /**
     * Removes a listener so it no longer is notified when text selection changes.
     *
     * @param l
     */
    public void removeTextSelectionListener(ActionListener l) {
<span class="nc" id="L690">        textSelectionListeners.removeListener(l);</span>
<span class="nc" id="L691">    }</span>

    private Container getLayeredPane() {
        //return root.getComponentForm().getLayeredPane(TextSelection.class, true);
<span class="fc" id="L695">        return root.getComponentForm().getFormLayeredPane(TextSelection.class, true);</span>
    }

    /**
     * Copies the current selection to the system clipboard.
     */
    public void copy() {
        //Display.impl.copyToClipboard(getSelectionAsText());
<span class="fc" id="L703">        Display.impl.copySelectionToClipboard(this);</span>
<span class="fc" id="L704">    }</span>

    /**
     * Selects all of the selectable text in the TextSelection (generally on the current form).
     */
    public void selectAll() {
<span class="pc bpc" id="L710" title="1 of 2 branches missed.">        if (selectionMask == null) {</span>
<span class="fc" id="L711">            selectionMask = new SelectionMask();</span>

<span class="fc" id="L713">            getLayeredPane().add(selectionMask);</span>

        }
<span class="fc" id="L716">        selectionRoot = root;</span>
<span class="fc" id="L717">        selectedBounds.setBounds(0, 0, selectionRoot.getWidth(), selectionRoot.getHeight());</span>
<span class="fc" id="L718">        update();</span>
<span class="fc" id="L719">        selectionRoot.getComponentForm().revalidateLater();</span>
<span class="fc" id="L720">        textSelectionListeners.fireActionEvent(new ActionEvent(TextSelection.this, Type.Change));</span>
<span class="fc" id="L721">    }</span>

    /**
     * This flag can be set to cause text selection to ignore pointer events which might cause
     * the selection to get lost or changed.  This is used internally when a context menu is displayed
     * so that clicking on the context menu doesn't cause the current text selection to be lost.
     *
     * @param ignore
     */
    public void setIgnoreEvents(boolean ignore) {
<span class="fc" id="L731">        ignoreEvents = ignore;</span>
<span class="fc" id="L732">    }</span>
    /**
     * Trigger types for text selection.
     */
<span class="fc" id="L736">    public enum TextSelectionTrigger {</span>
        /**
         * TextSelection is triggered by a pointer press and drag.  This is
         * consistent with desktop mouse text selection behaviour.
         */
<span class="fc" id="L741">        Press,</span>

        /**
         * Text selection is triggered by a long press on some text.
         */
<span class="fc" id="L746">        LongPress</span>
    }
    /**
     * An interface that can be returned from any Component's {@link Component#getTextSelectionSupport() } method to provide
     * text selection support on that component.
     */
    public interface TextSelectionSupport {

        /**
         * Gets the spans that should be selected for the given bounds.
         *
         * @param sel    The TextSelection instance.
         * @param bounds The bounds to check.  Relative to {@link #getSelectionRoot() }
         * @return Spans of text that should be selected.
         */
        Spans getTextSelectionForBounds(TextSelection sel, Rectangle bounds);

        /**
         * Checks if text selection is enabled for this component.
         *
         * @param sel The TextSelection instance.
         * @return True if text selection is enabled.
         */
        boolean isTextSelectionEnabled(TextSelection sel);

        /**
         * Checks if this component can be used to trigger a text selection.  On mobile devices
         * text selection is triggered with a long press over a component.
         *
         * @param sel The TextSelection instance.
         * @return True if text selection can be triggered on this component.
         */
        boolean isTextSelectionTriggerEnabled(TextSelection sel);

        /**
         * Trigger a text selection at a given point.
         *
         * @param sel The TextSelection instance
         * @param x   The x coordinate of the event.  Relative to {@link #getSelectionRoot() }
         * @param y   The y coordinate of the event.  Relative to {@link #getSelectionRoot() }
         * @return The span that should be selected by a long press at this point.
         */
        Span triggerSelectionAt(TextSelection sel, int x, int y);

        /**
         * Returns the text for a given span.
         *
         * @param sel  The TextSelection instance.
         * @param span The span describing the range of text that should be returned.
         * @return The text that is contained.
         */
        String getTextForSpan(TextSelection sel, Span span);

    }

    /**
     * Encapsulates a box around a single character/glyph in the UI, storing the component
     * that it belongs to, the position of its corresponding character in the component's text,
     * and the bounds of the box, relative to {@link #getSelectionRoot() }.
     */
    public class Char {

        /**
         * The bounds of the box, relative to {@link #getSelectionRoot() }
         */
<span class="fc" id="L811">        private final Rectangle bounds = new Rectangle();</span>

        /**
         * The position of the character in the text model.
         */
        private final int pos;

        /**
         * Creates a new Char
         *
         * @param pos    The position of the character.
         * @param bounds The bounds of the box, relative to {@link #getSelectionRoot() }
         */
<span class="fc" id="L824">        public Char(int pos, Rectangle bounds) {</span>
<span class="fc" id="L825">            this.pos = pos;</span>
<span class="fc" id="L826">            this.bounds.setBounds(bounds.getX(), bounds.getY(), bounds.getWidth(), bounds.getHeight());</span>
<span class="fc" id="L827">        }</span>

        /**
         * Creates a new Char
         *
         * @param pos THe position of the character.
         * @param x   The x-coord of the box, relative to {@link #getSelectionRoot() }
         * @param y   The y-coord of the box, relative to {@link #getSelectionRoot() }
         * @param w   The width of the box.
         * @param h   The height of the box.
         */
<span class="fc" id="L838">        public Char(int pos, int x, int y, int w, int h) {</span>
<span class="fc" id="L839">            this.pos = pos;</span>
<span class="fc" id="L840">            this.bounds.setBounds(x, y, w, h);</span>

<span class="fc" id="L842">        }</span>

        /**
         * Gets the character position.  This can be used by the Component that contains
         * the text to map it back to its model.
         *
         * @return The position of the character.
         */
        public int getPosition() {
<span class="fc" id="L851">            return pos;</span>
        }

        public String toString() {
<span class="nc" id="L855">            return &quot;Char{pos:&quot; + pos + &quot;, bounds:&quot; + bounds + &quot;}&quot;;</span>
        }

        /**
         * Translates the Char box.
         *
         * @param tx Translate x pixels.
         * @param ty Translate y pixels
         * @return A new Char translated.
         */
        public Char translate(int tx, int ty) {
<span class="fc" id="L866">            Char out = new Char(pos, bounds);</span>
<span class="fc" id="L867">            out.bounds.setX(out.bounds.getX() + tx);</span>
<span class="fc" id="L868">            out.bounds.setY(out.bounds.getY() + ty);</span>
<span class="fc" id="L869">            return out;</span>
        }
    }

    /**
     * Encapsulates a span of text on the screen.  This can only represent
     * a contiguous, single row of characters.
     */
    public class Span implements Iterable&lt;Char&gt; {


<span class="fc" id="L880">        private final Rectangle bounds = new Rectangle();</span>
<span class="fc" id="L881">        private final List&lt;Char&gt; chars = new ArrayList&lt;Char&gt;();</span>
        private Component component;
        private int startPos, endPos;
<span class="fc" id="L884">        private boolean boundsDirty = true;</span>


        /**
         * Creates a new span for the given component.
         *
         * @param c
         */
<span class="fc" id="L892">        public Span(Component c) {</span>
<span class="fc" id="L893">            component = c;</span>
<span class="fc" id="L894">        }</span>

        /**
         * Gets the start position of the text.
         *
         * @return
         */
        public int getStartPos() {
<span class="fc" id="L902">            return startPos;</span>
        }

        /**
         * Gets th end position of the text.  (exclusive).
         *
         * @return
         */
        public int getEndPos() {
<span class="fc" id="L911">            return endPos;</span>
        }

        @Override
        public Iterator&lt;Char&gt; iterator() {
<span class="nc" id="L916">            return chars.iterator();</span>
        }

        public String toString() {
<span class="nc" id="L920">            return &quot;Span{&quot; + chars + &quot;; Bounds: &quot; + getBounds() + &quot;}&quot;;</span>
        }

        /**
         * Calculates the bounds of the span based on the characters in the span
         */
        private void calculateBounds() {
<span class="fc" id="L927">            Char first = first();</span>
<span class="pc bpc" id="L928" title="1 of 2 branches missed.">            if (first != null) {</span>

<span class="fc" id="L930">                bounds.setBounds(first.bounds.getX(), first.bounds.getY(), first.bounds.getWidth(), first.bounds.getHeight());</span>
<span class="fc bfc" id="L931" title="All 2 branches covered.">                for (Char c : chars) {</span>
<span class="fc" id="L932">                    bounds.setWidth(c.bounds.getX() + c.bounds.getWidth() - bounds.getX());</span>

<span class="fc" id="L934">                }</span>

            } else {
<span class="nc" id="L937">                bounds.setBounds(0, 0, 0, 0);</span>
            }
<span class="fc" id="L939">            boundsDirty = false;</span>

<span class="fc" id="L941">        }</span>

        /**
         * Adds a character to the span, updating the bounds.
         *
         * @param character
         */
        public void add(Char character) {
<span class="fc" id="L949">            boundsDirty = true;</span>
<span class="fc bfc" id="L950" title="All 2 branches covered.">            if (chars.isEmpty()) {</span>
<span class="fc" id="L951">                startPos = character.pos;</span>
<span class="fc" id="L952">                endPos = character.pos + 1;</span>
            } else {
<span class="fc" id="L954">                startPos = Math.min(startPos, character.pos);</span>
<span class="fc" id="L955">                endPos = Math.max(endPos - 1, character.pos) + 1;</span>
            }
<span class="fc" id="L957">            chars.add(character);</span>
<span class="fc" id="L958">        }</span>

        /**
         * Obtains an intersection span including only the characters that intersect the given rectangle.
         *
         * @param x The x-coord of the intersection box, relative to {@link #getSelectionRoot() }
         * @param y The y-coord of the intersection box to {@link #getSelectionRoot() }
         * @param w The width of the intersection box.
         * @param h The height of the intersection box.
         * @return A new span containing only characters that intersect the given bounds.
         */
        public Span getIntersection(int x, int y, int w, int h) {
<span class="nc" id="L970">            return getIntersection(x, y, w, h, false);</span>
        }

        /**
         * Obtains an intersection span including only the characters that intersect the given rectangle.
         *
         * @param x        The x-coord of the intersection box, relative to {@link #getSelectionRoot() }
         * @param y        The y-coord of the intersection box to {@link #getSelectionRoot() }
         * @param w        The width of the intersection box.
         * @param h        The height of the intersection box.
         * @param withFlow If true, this will also include any characters that should logically be selected if the
         *                 user dragged over the given rectangle.  E.g. If the selection began above the span, and stretches below it,
         *                 the entire span should be selected (included in the intersection).
         * @return A new span with the intersection.
         */
        public Span getIntersection(int x, int y, int w, int h, boolean withFlow) {
<span class="fc" id="L986">            Span out = new Span(component);</span>
<span class="fc bfc" id="L987" title="All 2 branches covered.">            if (withFlow) {</span>
<span class="pc bpc" id="L988" title="1 of 4 branches missed.">                if (y &lt; getBounds().getY() &amp;&amp; y + h &gt; getBounds().getY() + getBounds().getHeight() / 2) {</span>
                    // Selection starts above and covers full height of the span
                    // In this case select the whole line
<span class="fc" id="L991">                    int newX = getBounds().getX();</span>
<span class="fc" id="L992">                    int newW = Math.max(0, getBounds().getWidth());</span>
<span class="fc" id="L993">                    x = newX;</span>
<span class="fc" id="L994">                    w = newW;</span>
<span class="pc bpc" id="L995" title="5 of 6 branches missed.">                } else if (y &lt; getBounds().getY() &amp;&amp; y + h &gt; getBounds().getY() &amp;&amp; y + h &lt;= getBounds().getY() + getBounds().getHeight()) {</span>
                    // Selection starts above the span, and vertically ends somewhere in the span.
                    // In this case, we select from the beginning of the line to the span box
<span class="nc" id="L998">                    int newX = getBounds().getX();</span>
<span class="nc" id="L999">                    int newW = Math.max(0, x + w - newX);</span>
<span class="nc" id="L1000">                    x = newX;</span>
<span class="nc" id="L1001">                    w = newW;</span>

<span class="pc bpc" id="L1003" title="2 of 4 branches missed.">                } else if (y &lt; getBounds().getY() + getBounds().getHeight() &amp;&amp; y + h &gt; getBounds().getY() + getBounds().getHeight() + CN.convertToPixels(2)) {</span>
                    // Selection starts inside vertically inside the span, and covers below.
                    // In this case select from selection start to end of line.
<span class="nc" id="L1006">                    w = Math.max(0, getBounds().getX() + getBounds().getWidth() - x);</span>
                }
            }
<span class="fc bfc" id="L1009" title="All 2 branches covered.">            for (Char c : chars) {</span>
<span class="fc bfc" id="L1010" title="All 2 branches covered.">                if (c.bounds.intersects(x, y, w, h)) {</span>
<span class="fc" id="L1011">                    out.add(c);</span>
                }
<span class="fc" id="L1013">            }</span>
<span class="fc" id="L1014">            return out;</span>
        }

        /**
         * Obtains an intersection span including only the characters that intersect the given rectangle.
         *
         * @param bounds   The bounds of the intersection box, relative to {@link #getSelectionRoot() }
         * @param withFlow If true, this will also include any characters that should logically be selected if the
         *                 user dragged over the given rectangle.  E.g. If the selection began above the span, and stretches below it,
         *                 the entire span should be selected (included in the intersection).
         * @return A new span with the intersection.
         */
        public Span getIntersection(Rectangle bounds, boolean withFlow) {
<span class="fc" id="L1027">            int x = bounds.getX();</span>
<span class="fc" id="L1028">            int y = bounds.getY();</span>
<span class="fc" id="L1029">            int w = bounds.getWidth();</span>
<span class="fc" id="L1030">            int h = bounds.getHeight();</span>
<span class="fc" id="L1031">            return getIntersection(x, y, w, h, withFlow);</span>

        }

        /**
         * Obtains an intersection span including only the characters that intersect the given rectangle.
         *
         * @param bounds The bounds of the intersection box, relative to {@link #getSelectionRoot() }
         * @return A new span with the intersection.
         */
        public Span getIntersection(Rectangle bounds) {
<span class="fc" id="L1042">            return getIntersection(bounds, false);</span>
        }

        /**
         * Gets the char at the given coordinate or null if there isn't a char there.
         *
         * @param x x-coordinate relative to {@link #getSelectionRoot() }
         * @param y y-coordinate relative to {@link #getSelectionRoot() }
         * @return
         */
        public Char charAt(int x, int y) {
<span class="pc bpc" id="L1053" title="1 of 2 branches missed.">            for (Char c : chars) {</span>
<span class="fc bfc" id="L1054" title="All 2 branches covered.">                if (c.bounds.contains(x, y)) {</span>
<span class="fc" id="L1055">                    return c;</span>
                }
<span class="fc" id="L1057">            }</span>
<span class="nc" id="L1058">            return null;</span>
        }

        /**
         * Gets the first Char in the span, or null if span is empty.
         *
         * @return The first Char, or null.
         */
        public Char first() {
<span class="pc bpc" id="L1067" title="1 of 2 branches missed.">            if (chars.size() == 0) {</span>
<span class="nc" id="L1068">                return null;</span>
            }
<span class="fc" id="L1070">            return chars.get(0);</span>
        }

        /**
         * Gets the last Char in the span, or null if the span is empty.
         *
         * @return The last Char or null.
         */
        public Char last() {
<span class="pc bpc" id="L1079" title="1 of 2 branches missed.">            if (chars.size() == 0) {</span>
<span class="nc" id="L1080">                return null;</span>
            }
<span class="fc" id="L1082">            return chars.get(chars.size() - 1);</span>
        }

        /**
         * Gets the number of Chars in the span.
         *
         * @return
         */
        public int size() {
<span class="fc" id="L1091">            return chars.size();</span>
        }

        /**
         * Gets a subspan containing the Chars between start (inclusive), and end (exclusive).
         *
         * @param start The start position of the Char to retrieve.
         * @param end   The end position of the Char to retrieve.
         * @return A new span including only the Chars at the given positions.
         */
        public Span subspan(int start, int end) {
<span class="fc" id="L1102">            Span out = new Span(component);</span>
<span class="fc bfc" id="L1103" title="All 2 branches covered.">            for (Char c : chars) {</span>
<span class="fc bfc" id="L1104" title="All 4 branches covered.">                if (c.pos &gt;= start &amp;&amp; c.pos &lt; end) {</span>

<span class="fc" id="L1106">                    out.add(c);</span>
                }
<span class="fc" id="L1108">            }</span>
<span class="fc" id="L1109">            return out;</span>
        }

        /**
         * Gets the bounds of the span.
         *
         * @return the bounds
         */
        public Rectangle getBounds() {
<span class="fc bfc" id="L1118" title="All 2 branches covered.">            if (boundsDirty) {</span>
<span class="fc" id="L1119">                calculateBounds();</span>
            }
<span class="fc" id="L1121">            return bounds;</span>
        }

        /**
         * Creates a translated span based on this one.
         *
         * @param tx x translation in pixels.
         * @param ty y translation in pixels.
         * @return A new span translated.
         */
        public Span translate(int tx, int ty) {
<span class="fc" id="L1132">            Span out = new Span(component);</span>
<span class="fc" id="L1133">            out.component = component;</span>
<span class="fc bfc" id="L1134" title="All 2 branches covered.">            for (Char c : chars) {</span>
<span class="fc" id="L1135">                out.add(c.translate(tx, ty));</span>
<span class="fc" id="L1136">            }</span>
<span class="fc" id="L1137">            return out;</span>
        }

        /**
         * Returns true if the span is empty.
         *
         * @return
         */
        public boolean isEmpty() {
<span class="fc" id="L1146">            return chars.isEmpty();</span>
        }

    }

    /**
     * Encapsulates a collection of Spans.
     */
<span class="fc" id="L1154">    public class Spans implements Iterable&lt;Span&gt; {</span>
<span class="fc" id="L1155">        private final List&lt;Span&gt; spans = new ArrayList&lt;Span&gt;();</span>

        @Override
        public Iterator&lt;Span&gt; iterator() {
<span class="fc" id="L1159">            return spans.iterator();</span>
        }

        /**
         * Adds all of the non-empty spans in the given spans collection to the current
         * spans collection.
         *
         * @param spans
         */
        public void add(Spans spans) {
<span class="fc bfc" id="L1169" title="All 2 branches covered.">            for (Span span : spans) {</span>
<span class="pc bpc" id="L1170" title="1 of 2 branches missed.">                if (span.isEmpty()) {</span>
<span class="nc" id="L1171">                    continue;</span>
                }
<span class="fc" id="L1173">                this.spans.add(span);</span>
<span class="fc" id="L1174">            }</span>
<span class="fc" id="L1175">        }</span>

        /**
         * Removes all spans.
         */
        public void clear() {
<span class="fc" id="L1181">            spans.clear();</span>
<span class="fc" id="L1182">        }</span>

        /**
         * Adds the given span to the collection, if it is non-empty.
         *
         * @param span
         */
        public void add(Span span) {
<span class="pc bpc" id="L1190" title="1 of 2 branches missed.">            if (!span.isEmpty()) {</span>
<span class="fc" id="L1191">                this.spans.add(span);</span>
            }
<span class="fc" id="L1193">        }</span>

        /**
         * Gets the first span in the collection.
         *
         * @return
         */
        public Span first() {
<span class="fc bfc" id="L1201" title="All 2 branches covered.">            if (spans.size() &gt; 0) {</span>
<span class="fc" id="L1202">                return spans.get(0);</span>
            }
<span class="fc" id="L1204">            return null;</span>
        }

        /**
         * Gets the last span in the collection.
         *
         * @return
         */
        public Span last() {
<span class="fc bfc" id="L1213" title="All 2 branches covered.">            if (spans.size() &gt; 0) {</span>
<span class="fc" id="L1214">                return spans.get(spans.size() - 1);</span>
            }
<span class="fc" id="L1216">            return null;</span>
        }

        /**
         * Gets the text contained in this spans collection.
         *
         * @return
         */
        public String getText() {
<span class="fc" id="L1225">            StringBuilder sb = new StringBuilder();</span>
<span class="fc" id="L1226">            Component currCmp = null;</span>
<span class="fc" id="L1227">            String lineSep = Display.getInstance().getLineSeparator();</span>
            //int originX = selectionRoot.getAbsoluteX();
<span class="fc" id="L1229">            int originY = selectionRoot.getAbsoluteY();</span>
<span class="fc bfc" id="L1230" title="All 2 branches covered.">            for (Span span : spans) {</span>
<span class="pc bpc" id="L1231" title="1 of 2 branches missed.">                if (currCmp != span.component) {</span>
<span class="pc bpc" id="L1232" title="1 of 2 branches missed.">                    if (currCmp != null) {</span>
<span class="nc bnc" id="L1233" title="All 2 branches missed.">                        if (span.getBounds().getY() &gt; currCmp.getAbsoluteY() + currCmp.getHeight() - originY) {</span>
<span class="nc" id="L1234">                            sb.append(lineSep);</span>
                        } else {
<span class="nc" id="L1236">                            sb.append(&quot;\t&quot;);</span>
                        }
                    }
                }
<span class="fc" id="L1240">                currCmp = span.component;</span>
<span class="fc" id="L1241">                TextSelectionSupport ts = span.component.getTextSelectionSupport();</span>
<span class="pc bpc" id="L1242" title="1 of 2 branches missed.">                if (ts != null) {</span>
<span class="fc" id="L1243">                    sb.append(ts.getTextForSpan(TextSelection.this, span));</span>
                }
<span class="fc" id="L1245">            }</span>
<span class="fc" id="L1246">            return sb.toString();</span>
        }

        @Override
        public String toString() {
<span class="nc" id="L1251">            StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L1252">            sb.append(&quot;Spans{&quot;);</span>
<span class="nc bnc" id="L1253" title="All 2 branches missed.">            for (Span span : spans) {</span>
<span class="nc" id="L1254">                sb.append(span.toString());</span>
<span class="nc" id="L1255">            }</span>
<span class="nc" id="L1256">            sb.append(&quot;}&quot;);</span>
<span class="nc" id="L1257">            return sb.toString();</span>
        }

        public Spans getIntersection(Rectangle bounds, boolean b) {
<span class="fc" id="L1261">            Spans out = new Spans();</span>
<span class="fc bfc" id="L1262" title="All 2 branches covered.">            for (Span span : spans) {</span>
<span class="fc" id="L1263">                out.add(span.getIntersection(bounds, b));</span>
<span class="fc" id="L1264">            }</span>
<span class="fc" id="L1265">            return out;</span>
        }

        public boolean isEmpty() {
<span class="pc bpc" id="L1269" title="1 of 2 branches missed.">            for (Span span : spans) {</span>
<span class="pc bpc" id="L1270" title="1 of 2 branches missed.">                if (!span.isEmpty()) {</span>
<span class="fc" id="L1271">                    return false;</span>
                }
<span class="nc" id="L1273">            }</span>
<span class="nc" id="L1274">            return true;</span>
        }

        public Char charAt(int x, int y) {
<span class="pc bpc" id="L1278" title="1 of 2 branches missed.">            for (Span span : spans) {</span>
<span class="fc" id="L1279">                Char c = span.charAt(x, y);</span>
<span class="pc bpc" id="L1280" title="1 of 2 branches missed.">                if (c != null) {</span>
<span class="fc" id="L1281">                    return c;</span>
                }
<span class="nc" id="L1283">            }</span>
<span class="nc" id="L1284">            return null;</span>
        }


        public Span spanOfCharAt(int x, int y) {
<span class="pc bpc" id="L1289" title="1 of 2 branches missed.">            for (Span span : spans) {</span>
<span class="fc" id="L1290">                Char c = span.charAt(x, y);</span>
<span class="pc bpc" id="L1291" title="1 of 2 branches missed.">                if (c != null) {</span>
<span class="fc" id="L1292">                    return span;</span>
                }
<span class="nc" id="L1294">            }</span>
<span class="nc" id="L1295">            return null;</span>
        }


    }

    private class SelectionMask extends Container {
<span class="fc" id="L1302">        private final DragHandle startHandle = new DragHandle(true);</span>
<span class="fc" id="L1303">        private final DragHandle endHandle = new DragHandle(false);</span>
<span class="fc" id="L1304">        private final SelectionMenu selectionMenu = new SelectionMenu();</span>

<span class="fc" id="L1306">        SelectionMask() {</span>
<span class="pc bpc" id="L1307" title="1 of 2 branches missed.">            if (trigger == TextSelectionTrigger.LongPress) {</span>
<span class="fc" id="L1308">                addAll(startHandle, endHandle, selectionMenu);</span>
            }
<span class="fc" id="L1310">        }</span>

        @Override
        protected Dimension calcPreferredSize() {
<span class="fc" id="L1314">            return new Dimension(CN.getDisplayWidth(), CN.getDisplayHeight());</span>
        }


        @Override
        public void paint(Graphics g) {
<span class="fc" id="L1320">            super.paint(g);</span>
<span class="fc" id="L1321">            g.setColor(0x0000ff);</span>
<span class="fc" id="L1322">            int alph = g.getAlpha();</span>
<span class="fc" id="L1323">            g.setAlpha(50);</span>
<span class="fc" id="L1324">            int tx = g.getTranslateX();</span>
<span class="fc" id="L1325">            int ty = g.getTranslateY();</span>
<span class="fc" id="L1326">            g.translate(-tx, -ty);</span>
<span class="fc" id="L1327">            int originX = selectionRoot.getAbsoluteX();</span>
<span class="fc" id="L1328">            int originY = selectionRoot.getAbsoluteY();</span>
<span class="fc" id="L1329">            g.translate(originX, originY);</span>
<span class="fc" id="L1330">            int clipX = g.getClipX();</span>
<span class="fc" id="L1331">            int clipY = g.getClipY();</span>
<span class="fc" id="L1332">            int clipW = g.getClipWidth();</span>
<span class="fc" id="L1333">            int clipH = g.getClipHeight();</span>
<span class="fc" id="L1334">            g.clipRect(selectionRoot.getScrollX(), selectionRoot.getScrollY(), selectionRoot.getWidth(), selectionRoot.getHeight());</span>

<span class="fc bfc" id="L1336" title="All 2 branches covered.">            for (Span span : selectedSpans) {</span>
<span class="fc" id="L1337">                int innerClipX = g.getClipX();</span>
<span class="fc" id="L1338">                int innerClipY = g.getClipY();</span>
<span class="fc" id="L1339">                int innerClipW = g.getClipWidth();</span>
<span class="fc" id="L1340">                int innerClipH = g.getClipHeight();</span>
<span class="fc" id="L1341">                clipTo(g, span.component, originX, originY);</span>
                //g.translate(span.component.getAbsoluteX(), span.component.getAbsoluteY());
<span class="fc" id="L1343">                g.fillRect(span.getBounds().getX(), span.getBounds().getY(), span.getBounds().getWidth(), span.getBounds().getHeight());</span>
                //g.translate(-span.component.getAbsoluteX(), -span.component.getAbsoluteY());
<span class="fc" id="L1345">                g.setClip(innerClipX, innerClipY, innerClipW, innerClipH);</span>
<span class="fc" id="L1346">            }</span>
<span class="fc" id="L1347">            updateSnappedSelectedBounds();</span>
            //g.drawRect(snappedSelectedBounds.getX(), snappedSelectedBounds.getY(), snappedSelectedBounds.getWidth(), snappedSelectedBounds.getHeight());
            //g.drawRect(selectedBounds.getX(), selectedBounds.getY(), selectedBounds.getWidth(), selectedBounds.getHeight());
<span class="fc" id="L1350">            g.setClip(clipX, clipY, clipW, clipH);</span>
<span class="fc" id="L1351">            g.translate(-originX, -originY);</span>
<span class="fc" id="L1352">            g.translate(tx, ty);</span>
<span class="fc" id="L1353">            g.setAlpha(alph);</span>
<span class="fc" id="L1354">        }</span>

        private void clipTo(Graphics g, Component cmp, int originX, int originY) {
<span class="fc" id="L1357">            g.clipRect(cmp.getAbsoluteX() - originX + cmp.getScrollX(), cmp.getAbsoluteY() - originY + cmp.getScrollY(), cmp.getWidth(), cmp.getHeight());</span>
<span class="fc bfc" id="L1358" title="All 2 branches covered.">            if (cmp.getParent() != null) {</span>
<span class="fc" id="L1359">                clipTo(g, cmp.getParent(), originX, originY);</span>
            }
<span class="fc" id="L1361">        }</span>

        @Override
        public void layoutContainer() {
<span class="fc" id="L1365">            super.layoutContainer();</span>
<span class="fc" id="L1366">            Span first = selectedSpans.first();</span>
<span class="fc" id="L1367">            Span last = selectedSpans.last();</span>
<span class="pc bpc" id="L1368" title="2 of 6 branches missed.">            if (first == null || last == null || trigger != TextSelectionTrigger.LongPress) {</span>
<span class="fc" id="L1369">                startHandle.setVisible(false);</span>
<span class="fc" id="L1370">                endHandle.setVisible(false);</span>
<span class="fc" id="L1371">                return;</span>
            }
<span class="fc" id="L1373">            int offX = selectionRoot.getAbsoluteX() - getAbsoluteX();</span>
<span class="fc" id="L1374">            int offY = selectionRoot.getAbsoluteY() - getAbsoluteY();</span>
<span class="fc" id="L1375">            startHandle.setVisible(true);</span>
<span class="fc" id="L1376">            endHandle.setVisible(true);</span>
<span class="fc" id="L1377">            startHandle.setX(offX + first.getBounds().getX() - startHandle.getPreferredW());</span>
<span class="fc" id="L1378">            startHandle.setY(offY + first.getBounds().getY());</span>
<span class="fc" id="L1379">            startHandle.setHeight(startHandle.getPreferredH() + first.getBounds().getHeight());</span>
<span class="fc" id="L1380">            startHandle.setWidth(startHandle.getPreferredW());</span>

<span class="fc" id="L1382">            endHandle.setX(offX + last.getBounds().getX() + last.getBounds().getWidth());</span>
<span class="fc" id="L1383">            endHandle.setY(offY + last.getBounds().getY());</span>
<span class="fc" id="L1384">            endHandle.setWidth(endHandle.getPreferredW());</span>
<span class="fc" id="L1385">            endHandle.setHeight(endHandle.getPreferredH() + last.getBounds().getHeight());</span>

<span class="fc" id="L1387">            int menuW = selectionMenu.getPreferredW();</span>
<span class="fc" id="L1388">            int menuH = selectionMenu.getPreferredH();</span>
<span class="fc" id="L1389">            int menuX = first.getBounds().getX() + offX;</span>
<span class="pc bpc" id="L1390" title="1 of 2 branches missed.">            if (menuX + menuW &gt; getWidth()) {</span>
<span class="nc" id="L1391">                menuX = getWidth() - menuW;</span>
            }
<span class="fc" id="L1393">            int menuY = offY + first.getBounds().getY() - menuH;</span>
<span class="pc bpc" id="L1394" title="1 of 2 branches missed.">            if (menuY &lt; 0) {</span>
<span class="fc" id="L1395">                menuY = offY + last.getBounds().getY() + last.getBounds().getHeight();</span>
            }
<span class="fc" id="L1397">            selectionMenu.setX(menuX);</span>
<span class="fc" id="L1398">            selectionMenu.setY(menuY);</span>
<span class="fc" id="L1399">            selectionMenu.setWidth(menuW);</span>
<span class="fc" id="L1400">            selectionMenu.setHeight(menuH);</span>

<span class="fc" id="L1402">        }</span>


    }

    private class SelectionMenu extends Container implements ActionListener {
<span class="fc" id="L1408">        Button copy = new HeavyButton(&quot;Copy&quot;);</span>
<span class="fc" id="L1409">        Button selectAll = new HeavyButton(&quot;Select All&quot;);</span>

<span class="fc" id="L1411">        SelectionMenu() {</span>
<span class="fc" id="L1412">            $(this).selectAllStyles()</span>
<span class="fc" id="L1413">                    .setBgColor(0x111111)</span>
<span class="fc" id="L1414">                    .setBgTransparency(255)</span>
<span class="fc" id="L1415">                    .setBorder(RoundRectBorder.create().cornerRadius(1));</span>
<span class="fc" id="L1416">            $(copy, selectAll).selectAllStyles()</span>
<span class="fc" id="L1417">                    .setFgColor(0xffffff);</span>
<span class="fc" id="L1418">            addAll(copy, selectAll);</span>
<span class="fc" id="L1419">            copy.addActionListener(this);</span>
<span class="fc" id="L1420">            selectAll.addActionListener(this);</span>
<span class="fc" id="L1421">        }</span>

        public void actionPerformed(ActionEvent e) {
<span class="nc bnc" id="L1424" title="All 2 branches missed.">            if (e.getSource() == selectAll) {</span>
<span class="nc" id="L1425">                selectAll();</span>
            } else {
<span class="nc" id="L1427">                copy();</span>
            }
<span class="nc" id="L1429">        }</span>
    }

    private class DragHandle extends Button {
        boolean start;
<span class="fc" id="L1434">        int diameter = CN.convertToPixels(4);</span>

<span class="fc" id="L1436">        DragHandle(boolean start) {</span>
<span class="fc" id="L1437">            this.start = start;</span>
<span class="fc" id="L1438">            this.setDraggable(true);</span>

<span class="fc" id="L1440">        }</span>

        @Override
        protected Image getDragImage() {
<span class="nc" id="L1444">            return null;</span>
        }

        @Override
        void drawDraggedImage(Graphics g) {

<span class="nc" id="L1450">        }</span>

        @Override
        protected void drawDraggedImage(Graphics g, Image img, int x, int y) {

<span class="nc" id="L1455">        }</span>

        @Override
        protected int getDragRegionStatus(int x, int y) {
<span class="nc" id="L1459">            return DRAG_REGION_IMMEDIATELY_DRAG_XY;</span>
        }


        public int getAbsolutePointerX() {
<span class="nc bnc" id="L1464" title="All 2 branches missed.">            return getAbsoluteX() + (start ? getWidth() : 0);</span>

        }

        public int getAbsolutePointerY() {
<span class="nc bnc" id="L1469" title="All 2 branches missed.">            return getAbsoluteY() + (start ? 0 : getHeight() - getPreferredH());</span>
        }

        @Override
        protected void initComponent() {
<span class="fc" id="L1474">            super.initComponent();</span>
<span class="fc" id="L1475">            addPointerPressedListener(pressListener);</span>
<span class="fc" id="L1476">            addPointerDraggedListener(pressListener);</span>
<span class="fc" id="L1477">            addPointerReleasedListener(pressListener);</span>
<span class="fc" id="L1478">            addDragFinishedListener(pressListener);</span>
<span class="fc" id="L1479">            addLongPressListener(pressListener);</span>
<span class="fc" id="L1480">        }</span>

        @Override
        protected void deinitialize() {
<span class="nc" id="L1484">            removePointerPressedListener(pressListener);</span>
<span class="nc" id="L1485">            removePointerDraggedListener(pressListener);</span>
<span class="nc" id="L1486">            removePointerReleasedListener(pressListener);</span>
<span class="nc" id="L1487">            removeDragFinishedListener(pressListener);</span>
<span class="nc" id="L1488">            addLongPressListener(pressListener);</span>
<span class="nc" id="L1489">            super.deinitialize();</span>
<span class="nc" id="L1490">        }</span>


        @Override
        protected Dimension calcPreferredSize() {
<span class="fc" id="L1495">            return new Dimension(diameter, diameter);</span>
        }

        @Override
        public void paint(Graphics g) {
<span class="fc" id="L1500">            super.paint(g);</span>
<span class="fc" id="L1501">            boolean antialias = g.isAntiAliased();</span>
<span class="fc" id="L1502">            g.setAntiAliased(true);</span>
<span class="fc" id="L1503">            g.setColor(0x0000ff);</span>
<span class="fc" id="L1504">            int x = getX();</span>
<span class="fc" id="L1505">            int y = getY() + getHeight() - getPreferredH();</span>
<span class="fc" id="L1506">            int w = getWidth();</span>
<span class="fc" id="L1507">            int h = getPreferredH();</span>
<span class="fc bfc" id="L1508" title="All 2 branches covered.">            if (start) {</span>
<span class="fc" id="L1509">                g.fillArc(x, y, w, h, 0, 360);</span>
<span class="fc" id="L1510">                g.fillRect(x + w / 2, y, w / 2, h / 2);</span>
<span class="fc" id="L1511">                g.drawRect(x + w / 2, y, w / 2, h / 2);</span>
            } else {
<span class="fc" id="L1513">                g.fillArc(x, y, w, h, 0, 360);</span>
<span class="fc" id="L1514">                g.fillRect(x, y, w / 2, h / 2);</span>
<span class="fc" id="L1515">                g.drawRect(x, y, w / 2, h / 2);</span>
            }
<span class="fc" id="L1517">            g.setAntiAliased(antialias);</span>
<span class="fc" id="L1518">        }</span>


    }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>